<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/processor/Manager.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2010  Mark Harrah
 */</span>
<span class="keyword">package</span> sbt.processor

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> xsbt.Paths._
<span class="keyword">import</span> ProcessorException.error

<span class="comment">/** Files needed by ManagerImpl.
* `retrieveBaseDirectory` is the directory that processors are retrieved under.
* `retrieveLockFile` is used to synchronize access to that directory.
* `definitionsFile` is the file to save repository and processor definitions to.  It is usually per-user instead of per-project.*/</span>
<span class="keyword">class</span> <a title="class ManagerFiles extends java.lang.Object with ScalaObject" id="12004">ManagerFiles</a>(<span class="keyword">val</span> <a title="java.io.File" id="69868">retrieveBaseDirectory</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69869">retrieveLockFile</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69870">definitionsFile</a>: <span title="java.io.File">File</span>)

<span class="keyword">class</span> <a title="class ManagerImpl extends java.lang.Object with sbt.processor.Manager with ScalaObject" id="12118">ManagerImpl</a>(<a title="sbt.processor.ManagerFiles" id="69912">files</a>: <a href="#12004" title="sbt.processor.ManagerFiles">ManagerFiles</a>, <a title="String" id="69913">scalaVersion</a>: <span title="String">String</span>, <a title="sbt.processor.Persist" id="69914">persist</a>: <a href="Persist.scala.html#12055" title="sbt.processor.Persist">Persist</a>, <a title="Boolean" id="69915">localOnly</a>: <span title="Boolean">Boolean</span>, <a title="sbt.Logger" id="69916">log</a>: <a href="../Logger.scala.html#11865" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> <a href="Processor.scala.html#11932" title="sbt.processor.Manager">Manager</a>
{
	<span class="keyword">import</span> files._
	
	<span class="keyword">def</span> <a title="(String)Option[sbt.processor.ProcessorDefinition]" id="69883">processorDefinition</a>(<a title="String" id="69917">label</a>: <span title="String">String</span>): <span title="Option[sbt.processor.ProcessorDefinition]">Option</span>[ProcessorDefinition] = <a href="#69893" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">processors</a>.<span title="(String)Option[sbt.processor.ProcessorDefinition]">get</span>(<a href="#69917" title="String">label</a>)
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Option[sbt.processor.Processor]" id="69884">processor</a>(<a title="sbt.processor.ProcessorDefinition" id="69967">pdef</a>: <a href="Processor.scala.html#11947" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>): <span title="Option[sbt.processor.Processor]">Option</span>[Processor] =
	{
		<span class="keyword">def</span> <a title="=&gt; Either[Throwable,sbt.processor.Processor]" id="69968">tryProcessor</a>: <a title="Either[Throwable,sbt.processor.Processor]" id="336">Either</a>[Throwable, Processor] =
			(<span title="sbt.processor.Loader" class="keyword">new</span> <a href="Loader.scala.html#12097" title="sbt.processor.Loader">Loader</a>).<a href="Loader.scala.html#47957" title="(java.io.File)Either[Throwable,sbt.processor.Processor]">getProcessor</a>( <a href="#69901" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#69967" title="sbt.processor.ProcessorDefinition">pdef</a>) )

		 <span class="comment">// try to load the processor.  It will succeed here if the processor has already been retrieved</span>
		<a href="#69968" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Either[Unit,sbt.processor.Processor])Either[Unit,sbt.processor.Processor]" id="25809">flatMap</a> { <a title="Throwable" id="69989">_</a> =&gt;
			 <span class="comment">// if it hasn't been retrieved, retrieve the processor and its dependencies</span>
			<a href="#69888" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#69967" title="sbt.processor.ProcessorDefinition">pdef</a>, <a href="#69915" title="Boolean">localOnly</a>)
			<span class="comment">// try to load the processor now that it has been retrieved</span>
			<a href="#69968" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Unit)Either[Unit,sbt.processor.Processor] with Product" id="25812">map</a> <a href="#69998" title="Unit">{</a> <span class="comment">// if that fails, log a warning</span>
				<span title="Unit" class="keyword">case</span> <a title="sbt.processor.ProcessorException" id="69999">p</a>: <a href="Processor.scala.html#12025" title="sbt.processor.ProcessorException">ProcessorException</a> =&gt; <a href="#69916" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19735" title="(=&gt; String)Unit">warn</a>(<a href="#69999" title="sbt.processor.ProcessorException">p</a>.<a title="()java.lang.String" id="17827">getMessage</a>)
				<span title="Unit" class="keyword">case</span> <a title="Throwable" id="70001">t</a> =&gt; <a href="#69916" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19731" title="(=&gt; Throwable)Unit">trace</a>(<a href="#70001" title="Throwable">t</a>); <a href="#69916" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19735" title="(=&gt; String)Unit">warn</a>(<a href="#70001" title="Throwable">t</a>.<a title="()java.lang.String" id="17831">toString</a>)
			}
		}.<a title="=&gt; Either.RightProjection[Unit,sbt.processor.Processor]" id="25882">right</a>.<a title="=&gt; Option[sbt.processor.Processor]" id="25854">toOption</a>
	}
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Unit" id="69885">defineProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="70006">p</a>: <a href="Processor.scala.html#11947" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>)
	{
		<a href="#69894" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#70006" title="sbt.processor.ProcessorDefinition">p</a>)
		<a href="#69888" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#70006" title="sbt.processor.ProcessorDefinition">p</a>, <a href="#69915" title="Boolean">localOnly</a>)
		<a href="#69889" title="(sbt.processor.Definition)Unit">add</a>(<a href="#70006" title="sbt.processor.ProcessorDefinition">p</a>)
	}
	<span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)Unit" id="69886">defineRepository</a>(<a title="sbt.processor.RepositoryDefinition" id="70009">r</a>: <a href="Processor.scala.html#11956" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>)
	{
		<a href="#69894" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#70009" title="sbt.processor.RepositoryDefinition">r</a>)
		<a href="#69889" title="(sbt.processor.Definition)Unit">add</a>(<a href="#70009" title="sbt.processor.RepositoryDefinition">r</a>)
	}
	<span class="keyword">def</span> <a title="(String)sbt.processor.Definition" id="69887">removeDefinition</a>(<a title="String" id="70010">label</a>: <span title="String">String</span>): <a href="Processor.scala.html#11998" title="sbt.processor.Definition">Definition</a> =
		<a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<a title="(String)Option[sbt.processor.Definition]" id="24517">removeKey</a>(<a href="#70010" title="String">label</a>) <span title="sbt.processor.Definition" class="keyword">match</span>
		{
			<span title="sbt.processor.Definition" class="keyword">case</span> Some(<a title="sbt.processor.Definition" id="70011">removed</a>) =&gt;
				<a href="#69902" title="()Unit">saveDefinitions</a>()
				<a href="#70011" title="sbt.processor.Definition">removed</a>
			<span title="Nothing" class="keyword">case</span> <a title="object None" id="505">None</a> =&gt; <a href="Processor.scala.html#31982" title="(String)Nothing">error</a>(<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#70010" title="String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' not defined.&quot;)" class="string">&quot;' not defined.&quot;</span>)
		}
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition,Boolean)Unit" id="69888">retrieveProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="69990">p</a>: <a href="Processor.scala.html#11947" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>, <a title="Boolean" id="69991">localOnly</a>: <span title="Boolean">Boolean</span>): <span title="Unit">Unit</span> =
	{
		<span class="keyword">val</span> <a title="List[sbt.Resolver]" id="70020">resolvers</a> = <a href="#69892" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">repositories</a>.<span title="=&gt; Iterator[sbt.processor.RepositoryDefinition]">values</span>.<span title="=&gt; List[sbt.processor.RepositoryDefinition]">toList</span>.<a title="((sbt.processor.RepositoryDefinition) =&gt; sbt.Resolver)List[sbt.Resolver]" id="17963">map</a>(<a href="#69900" title="(sbt.processor.RepositoryDefinition)sbt.Resolver">toResolver</a>)
		<span class="keyword">val</span> <a title="sbt.ModuleID" id="70021">module</a> = <a href="#69990" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31853" title="(String)sbt.ModuleID">toModuleID</a>(<a href="#69913" title="String">scalaVersion</a>)
		( <span title="sbt.processor.Retrieve" class="keyword">new</span> <a href="Retrieve.scala.html#12094" title="sbt.processor.Retrieve">Retrieve</a>(<a href="#69901" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#69990" title="sbt.processor.ProcessorDefinition">p</a>), <a href="#70021" title="sbt.ModuleID">module</a>, <a href="#69914" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34051" title="=&gt; xsbti.GlobalLock">lock</a>, <a href="#69869" title="=&gt; java.io.File">retrieveLockFile</a>, <a href="#70020" title="List[sbt.Resolver]">resolvers</a>, <a href="#69916" title="sbt.Logger">log</a>) ).<a href="Retrieve.scala.html#55816" title="(Boolean)Unit">retrieve</a>(<a href="#69991" title="Boolean">localOnly</a>)
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69889">add</a>(<a title="sbt.processor.Definition" id="70008">d</a>: <a href="Processor.scala.html#11998" title="sbt.processor.Definition">Definition</a>)
	{
		<a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>(<a href="#70008" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#31837" title="=&gt; String">label</a>) = <a href="#70008" title="sbt.processor.Definition">d</a>
		<a href="#69902" title="()Unit">saveDefinitions</a>()
	}

	<span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69891">definitions</a> = <a href="#69904" title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]">loadDefinitions</a>(<a href="#69870" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]" id="69892">repositories</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.RepositoryDefinition)])scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">++</span> <a href="#69895" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.RepositoryDefinition)])Iterable[(String, sbt.processor.RepositoryDefinition)]">partialMap</a>(<a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#70050" title="(String, sbt.processor.RepositoryDefinition)">{</a> <span title="(String, sbt.processor.RepositoryDefinition)" class="keyword">case</span> (<a title="String" id="70051">label</a>, <a title="sbt.processor.RepositoryDefinition" id="70052">d</a>: <a href="Processor.scala.html#11956" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>) =&gt; <span title="(String,sbt.processor.RepositoryDefinition)(String, sbt.processor.RepositoryDefinition)">(</span><a href="#70051" title="String">label</a>, <a href="#70052" title="sbt.processor.RepositoryDefinition">d</a>) }
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]" id="69893">processors</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.ProcessorDefinition)])scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">++</span> <a href="#69895" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.ProcessorDefinition)])Iterable[(String, sbt.processor.ProcessorDefinition)]">partialMap</a>(<a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#69956" title="(String, sbt.processor.ProcessorDefinition)">{</a> <span title="(String, sbt.processor.ProcessorDefinition)" class="keyword">case</span> (<a title="String" id="69957">label</a>, <a title="sbt.processor.ProcessorDefinition" id="69958">p</a>: <a href="Processor.scala.html#11947" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) =&gt; <span title="(String,sbt.processor.ProcessorDefinition)(String, sbt.processor.ProcessorDefinition)">(</span><a href="#69957" title="String">label</a>, <a href="#69958" title="sbt.processor.ProcessorDefinition">p</a>) }
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69894">checkExisting</a>(<a title="sbt.processor.Definition" id="70007">p</a>: <a href="Processor.scala.html#11998" title="sbt.processor.Definition">Definition</a>): <span title="Unit">Unit</span>  =  <a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="(String)Option[sbt.processor.Definition]">get</span>(<a href="#70007" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#31837" title="=&gt; String">label</a>) <a title="((sbt.processor.Definition) =&gt; Nothing)Option[Nothing]" id="19234">map</a> { <a title="sbt.processor.Definition" id="70071">d</a> =&gt; <a href="Processor.scala.html#31982" title="(String)Nothing">error</a> (<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#70007" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#31837" title="=&gt; String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' already in use: &quot;)" class="string">&quot;' already in use: &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#70071" title="sbt.processor.Definition">d</a>) }
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T, S](Iterable[T])(PartialFunction[T,S])Iterable[S]" id="69895">partialMap</a>[<a title="&gt;: Nothing &lt;: Any" id="69898">T</a>,<a title="&gt;: Nothing &lt;: Any" id="69899">S</a>](<a title="Iterable[T]" id="69946">i</a>: <a title="Iterable[T]" id="372">Iterable</a>[T])(<a title="PartialFunction[T,S]" id="69947">f</a>: <a title="PartialFunction[T,S]" id="1245">PartialFunction</a>[T,S]) = <a href="#69946" title="Iterable[T]">i</a>.<a title="((T) =&gt; Boolean)Iterable[T]" id="16275">filter</a>(<a href="#69947" title="PartialFunction[T,S]">f</a>.<a href="#69950" title="(T)Boolean" id="16839">isDefinedAt</a>).<a title="((T) =&gt; S)Iterable[S]" id="16271">map</a>(<a href="#69947" title="PartialFunction[T,S]">f</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)sbt.Resolver" id="69900">toResolver</a>(<a title="sbt.processor.RepositoryDefinition" id="70063">repo</a>: <a href="Processor.scala.html#11956" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>): <a href="../../IvyInterface.scala.html#11181" title="sbt.Resolver">Resolver</a> = <span title="sbt.MavenRepository" class="keyword">new</span> <a href="../../IvyInterface.scala.html#8460" title="sbt.MavenRepository">MavenRepository</a>(<a href="#70063" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#31858" title="=&gt; String">label</a>, <a href="#70063" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#31860" title="=&gt; String">url</a>)

	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)java.io.File" id="69901">retrieveDirectory</a>(<a title="sbt.processor.ProcessorDefinition" id="69970">p</a>: <a href="Processor.scala.html#11947" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) = <a href="../../Paths.scala.html#47948" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">retrieveBaseDirectory</a> <a href="../../Paths.scala.html#47948" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#69970" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31844" title="=&gt; String">group</a> <a href="../../Paths.scala.html#47948" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#69970" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31846" title="=&gt; String">module</a> <a href="../../Paths.scala.html#47998" title="(String)java.io.File">/</a> <a href="#69970" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31848" title="=&gt; String">rev</a>
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="69902">saveDefinitions</a>(): <span title="Unit">Unit</span> = <a href="#69903" title="(java.io.File)Unit">saveDefinitions</a>(<a href="#69870" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Unit" id="69903">saveDefinitions</a>(<a title="java.io.File" id="70013">file</a>: <span title="java.io.File">File</span>): <span title="Unit">Unit</span> = <a href="#69914" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34059" title="(java.io.File)(Iterable[sbt.processor.Definition])Unit">save</a>(<a href="#70013" title="java.io.File">file</a>)(<a href="#69890" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="=&gt; Iterator[sbt.processor.Definition]">values</span>.<span title="=&gt; List[sbt.processor.Definition]">toList</span>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69904">loadDefinitions</a>(<a title="java.io.File" id="69954">file</a>: <span title="java.io.File">File</span>): scala.collection.mutable.<a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="15729">Map</a>[String, Definition] =
		scala.collection.mutable.<a title="((String, sbt.processor.Definition)*)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="15928">HashMap</a>(  (<span title="Seq[(String, sbt.processor.Definition)]" class="keyword">if</span>(<a href="#69954" title="java.io.File">file</a>.<a title="()Boolean" id="16232">exists</a>) <a href="#69905" title="(java.io.File)Seq[(String, sbt.processor.Definition)]">rawLoad</a>(<a href="#69954" title="java.io.File">file</a>) <span class="keyword">else</span> <a title="object Nil" id="310">Nil</a>) : _*)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Seq[(String, sbt.processor.Definition)]" id="69905">rawLoad</a>(<a title="java.io.File" id="70076">file</a>: <span title="java.io.File">File</span>): <a title="Seq[(String, sbt.processor.Definition)]" id="729">Seq</a>[(String, Definition)] = <a href="#69914" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34060" title="(java.io.File)Seq[sbt.processor.Definition]">load</a>(<a href="#69870" title="=&gt; java.io.File">definitionsFile</a>).<a title="((sbt.processor.Definition) =&gt; (String, sbt.processor.Definition))Seq[(String, sbt.processor.Definition)]" id="16749">map</a> { <a title="sbt.processor.Definition" id="70080">d</a> =&gt; <span title="(String,sbt.processor.Definition)(String, sbt.processor.Definition)">(</span><a href="#70080" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#31837" title="=&gt; String">label</a>, <a href="#70080" title="sbt.processor.Definition">d</a>) }
}
        </pre>
    </body>
</html>