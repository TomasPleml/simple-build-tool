<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/processor/Manager.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2010  Mark Harrah
 */</span>
<span class="keyword">package</span> sbt.processor

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> xsbt.Paths._
<span class="keyword">import</span> ProcessorException.error

<span class="comment">/** Files needed by ManagerImpl.
* `retrieveBaseDirectory` is the directory that processors are retrieved under.
* `retrieveLockFile` is used to synchronize access to that directory.
* `definitionsFile` is the file to save repository and processor definitions to.  It is usually per-user instead of per-project.*/</span>
<span class="keyword">class</span> <a title="class ManagerFiles extends java.lang.Object with ScalaObject" id="11921">ManagerFiles</a>(<span class="keyword">val</span> <a title="java.io.File" id="69351">retrieveBaseDirectory</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69352">retrieveLockFile</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69353">definitionsFile</a>: <span title="java.io.File">File</span>)

<span class="keyword">class</span> <a title="class ManagerImpl extends java.lang.Object with sbt.processor.Manager with ScalaObject" id="12035">ManagerImpl</a>(<a title="sbt.processor.ManagerFiles" id="69392">files</a>: <a href="#11921" title="sbt.processor.ManagerFiles">ManagerFiles</a>, <a title="String" id="69393">scalaVersion</a>: <span title="String">String</span>, <a title="sbt.processor.Persist" id="69394">persist</a>: <a href="Persist.scala.html#11972" title="sbt.processor.Persist">Persist</a>, <a title="sbt.Logger" id="69395">log</a>: <a href="../Logger.scala.html#11784" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> <a href="Processor.scala.html#11849" title="sbt.processor.Manager">Manager</a>
{
	<span class="keyword">import</span> files._
	
	<span class="keyword">def</span> <a title="(String)Option[sbt.processor.ProcessorDefinition]" id="69364">processorDefinition</a>(<a title="String" id="69396">label</a>: <span title="String">String</span>): <span title="Option[sbt.processor.ProcessorDefinition]">Option</span>[ProcessorDefinition] = <a href="#69374" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">processors</a>.<span title="(String)Option[sbt.processor.ProcessorDefinition]">get</span>(<a href="#69396" title="String">label</a>)
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Option[sbt.processor.Processor]" id="69365">processor</a>(<a title="sbt.processor.ProcessorDefinition" id="69446">pdef</a>: <a href="Processor.scala.html#11858" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>): <span title="Option[sbt.processor.Processor]">Option</span>[Processor] =
	{
		<span class="keyword">def</span> <a title="=&gt; Either[Throwable,sbt.processor.Processor]" id="69447">tryProcessor</a>: <a title="Either[Throwable,sbt.processor.Processor]" id="336">Either</a>[Throwable, Processor] =
			(<span title="sbt.processor.Loader" class="keyword">new</span> <a href="Loader.scala.html#12014" title="sbt.processor.Loader">Loader</a>).<a href="Loader.scala.html#47771" title="(java.io.File)Either[Throwable,sbt.processor.Processor]">getProcessor</a>( <a href="#69382" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#69446" title="sbt.processor.ProcessorDefinition">pdef</a>) )

		 <span class="comment">// try to load the processor.  It will succeed here if the processor has already been retrieved</span>
		<a href="#69447" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Either[Unit,sbt.processor.Processor])Either[Unit,sbt.processor.Processor]" id="25477">flatMap</a> { <a title="Throwable" id="69468">_</a> =&gt;
			 <span class="comment">// if it hasn't been retrieved, retrieve the processor and its dependencies</span>
			<a href="#69369" title="(sbt.processor.ProcessorDefinition)Unit">retrieveProcessor</a>(<a href="#69446" title="sbt.processor.ProcessorDefinition">pdef</a>)
			<span class="comment">// try to load the processor now that it has been retrieved</span>
			<a href="#69447" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Unit)Either[Unit,sbt.processor.Processor] with Product" id="25480">map</a> <a href="#69476" title="Unit">{</a> <span class="comment">// if that fails, log a warning</span>
				<span title="Unit" class="keyword">case</span> <a title="sbt.processor.ProcessorException" id="69477">p</a>: <a href="Processor.scala.html#11942" title="sbt.processor.ProcessorException">ProcessorException</a> =&gt; <a href="#69395" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19518" title="(=&gt; String)Unit">warn</a>(<a href="#69477" title="sbt.processor.ProcessorException">p</a>.<a title="()java.lang.String" id="17616">getMessage</a>)
				<span title="Unit" class="keyword">case</span> <a title="Throwable" id="69479">t</a> =&gt; <a href="#69395" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19514" title="(=&gt; Throwable)Unit">trace</a>(<a href="#69479" title="Throwable">t</a>); <a href="#69395" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#19518" title="(=&gt; String)Unit">warn</a>(<a href="#69479" title="Throwable">t</a>.<a title="()java.lang.String" id="17620">toString</a>)
			}
		}.<a title="=&gt; Either.RightProjection[Unit,sbt.processor.Processor]" id="25550">right</a>.<a title="=&gt; Option[sbt.processor.Processor]" id="25522">toOption</a>
	}
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Unit" id="69366">defineProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="69484">p</a>: <a href="Processor.scala.html#11858" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>)
	{
		<a href="#69375" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#69484" title="sbt.processor.ProcessorDefinition">p</a>)
		<a href="#69369" title="(sbt.processor.ProcessorDefinition)Unit">retrieveProcessor</a>(<a href="#69484" title="sbt.processor.ProcessorDefinition">p</a>)
		<a href="#69370" title="(sbt.processor.Definition)Unit">add</a>(<a href="#69484" title="sbt.processor.ProcessorDefinition">p</a>)
	}
	<span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)Unit" id="69367">defineRepository</a>(<a title="sbt.processor.RepositoryDefinition" id="69487">r</a>: <a href="Processor.scala.html#11873" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>)
	{
		<a href="#69375" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#69487" title="sbt.processor.RepositoryDefinition">r</a>)
		<a href="#69370" title="(sbt.processor.Definition)Unit">add</a>(<a href="#69487" title="sbt.processor.RepositoryDefinition">r</a>)
	}
	<span class="keyword">def</span> <a title="(String)sbt.processor.Definition" id="69368">removeDefinition</a>(<a title="String" id="69488">label</a>: <span title="String">String</span>): <a href="Processor.scala.html#11915" title="sbt.processor.Definition">Definition</a> =
		<a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<a title="(String)Option[sbt.processor.Definition]" id="24187">removeKey</a>(<a href="#69488" title="String">label</a>) <span title="sbt.processor.Definition" class="keyword">match</span>
		{
			<span title="sbt.processor.Definition" class="keyword">case</span> Some(<a title="sbt.processor.Definition" id="69489">removed</a>) =&gt;
				<a href="#69383" title="()Unit">saveDefinitions</a>()
				<a href="#69489" title="sbt.processor.Definition">removed</a>
			<span title="Nothing" class="keyword">case</span> <a title="object None" id="505">None</a> =&gt; <a href="Processor.scala.html#31617" title="(String)Nothing">error</a>(<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#69488" title="String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' not defined.&quot;)" class="string">&quot;' not defined.&quot;</span>)
		}
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Unit" id="69369">retrieveProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="69469">p</a>: <a href="Processor.scala.html#11858" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>): <span title="Unit">Unit</span> =
	{
		<span class="keyword">val</span> <a title="List[sbt.Resolver]" id="69498">resolvers</a> = <a href="#69373" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">repositories</a>.<span title="=&gt; Iterator[sbt.processor.RepositoryDefinition]">values</span>.<span title="=&gt; List[sbt.processor.RepositoryDefinition]">toList</span>.<a title="((sbt.processor.RepositoryDefinition) =&gt; sbt.Resolver)List[sbt.Resolver]" id="17752">map</a>(<a href="#69381" title="(sbt.processor.RepositoryDefinition)sbt.Resolver">toResolver</a>)
		<span class="keyword">val</span> <a title="sbt.ModuleID" id="69499">module</a> = <a href="#69469" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31488" title="(String)sbt.ModuleID">toModuleID</a>(<a href="#69393" title="String">scalaVersion</a>)
		( <span title="sbt.processor.Retrieve" class="keyword">new</span> <a href="Retrieve.scala.html#12011" title="sbt.processor.Retrieve">Retrieve</a>(<a href="#69382" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#69469" title="sbt.processor.ProcessorDefinition">p</a>), <a href="#69499" title="sbt.ModuleID">module</a>, <a href="#69394" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34066" title="=&gt; xsbti.GlobalLock">lock</a>, <a href="#69352" title="=&gt; java.io.File">retrieveLockFile</a>, <a href="#69498" title="List[sbt.Resolver]">resolvers</a>, <a href="#69395" title="sbt.Logger">log</a>) ).<a href="Retrieve.scala.html#55566" title="()Unit">retrieve</a>()
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69370">add</a>(<a title="sbt.processor.Definition" id="69486">d</a>: <a href="Processor.scala.html#11915" title="sbt.processor.Definition">Definition</a>)
	{
		<a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>(<a href="#69486" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#31472" title="=&gt; String">label</a>) = <a href="#69486" title="sbt.processor.Definition">d</a>
		<a href="#69383" title="()Unit">saveDefinitions</a>()
	}

	<span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69372">definitions</a> = <a href="#69385" title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]">loadDefinitions</a>(<a href="#69353" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]" id="69373">repositories</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.RepositoryDefinition)])scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">++</span> <a href="#69376" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.RepositoryDefinition)])Iterable[(String, sbt.processor.RepositoryDefinition)]">partialMap</a>(<a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#69528" title="(String, sbt.processor.RepositoryDefinition)">{</a> <span title="(String, sbt.processor.RepositoryDefinition)" class="keyword">case</span> (<a title="String" id="69529">label</a>, <a title="sbt.processor.RepositoryDefinition" id="69530">d</a>: <a href="Processor.scala.html#11873" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>) =&gt; <span title="(String,sbt.processor.RepositoryDefinition)(String, sbt.processor.RepositoryDefinition)">(</span><a href="#69529" title="String">label</a>, <a href="#69530" title="sbt.processor.RepositoryDefinition">d</a>) }
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]" id="69374">processors</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.ProcessorDefinition)])scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">++</span> <a href="#69376" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.ProcessorDefinition)])Iterable[(String, sbt.processor.ProcessorDefinition)]">partialMap</a>(<a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#69435" title="(String, sbt.processor.ProcessorDefinition)">{</a> <span title="(String, sbt.processor.ProcessorDefinition)" class="keyword">case</span> (<a title="String" id="69436">label</a>, <a title="sbt.processor.ProcessorDefinition" id="69437">p</a>: <a href="Processor.scala.html#11858" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) =&gt; <span title="(String,sbt.processor.ProcessorDefinition)(String, sbt.processor.ProcessorDefinition)">(</span><a href="#69436" title="String">label</a>, <a href="#69437" title="sbt.processor.ProcessorDefinition">p</a>) }
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69375">checkExisting</a>(<a title="sbt.processor.Definition" id="69485">p</a>: <a href="Processor.scala.html#11915" title="sbt.processor.Definition">Definition</a>): <span title="Unit">Unit</span>  =  <a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="(String)Option[sbt.processor.Definition]">get</span>(<a href="#69485" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#31472" title="=&gt; String">label</a>) <a title="((sbt.processor.Definition) =&gt; Nothing)Option[Nothing]" id="19017">map</a> { <a title="sbt.processor.Definition" id="69549">d</a> =&gt; <a href="Processor.scala.html#31617" title="(String)Nothing">error</a> (<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#69485" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#31472" title="=&gt; String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' already in use: &quot;)" class="string">&quot;' already in use: &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#69549" title="sbt.processor.Definition">d</a>) }
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T, S](Iterable[T])(PartialFunction[T,S])Iterable[S]" id="69376">partialMap</a>[<a title="&gt;: Nothing &lt;: Any" id="69379">T</a>,<a title="&gt;: Nothing &lt;: Any" id="69380">S</a>](<a title="Iterable[T]" id="69425">i</a>: <a title="Iterable[T]" id="372">Iterable</a>[T])(<a title="PartialFunction[T,S]" id="69426">f</a>: <a title="PartialFunction[T,S]" id="1245">PartialFunction</a>[T,S]) = <a href="#69425" title="Iterable[T]">i</a>.<a title="((T) =&gt; Boolean)Iterable[T]" id="16064">filter</a>(<a href="#69426" title="PartialFunction[T,S]">f</a>.<a href="#69429" title="(T)Boolean" id="16628">isDefinedAt</a>).<a title="((T) =&gt; S)Iterable[S]" id="16060">map</a>(<a href="#69426" title="PartialFunction[T,S]">f</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)sbt.Resolver" id="69381">toResolver</a>(<a title="sbt.processor.RepositoryDefinition" id="69541">repo</a>: <a href="Processor.scala.html#11873" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>): <a href="../../IvyInterface.scala.html#11133" title="sbt.Resolver">Resolver</a> = <span title="sbt.MavenRepository" class="keyword">new</span> <a href="../../IvyInterface.scala.html#8418" title="sbt.MavenRepository">MavenRepository</a>(<a href="#69541" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#31493" title="=&gt; String">label</a>, <a href="#69541" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#31495" title="=&gt; String">url</a>)

	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)java.io.File" id="69382">retrieveDirectory</a>(<a title="sbt.processor.ProcessorDefinition" id="69449">p</a>: <a href="Processor.scala.html#11858" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) = <a href="../../Paths.scala.html#47762" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">retrieveBaseDirectory</a> <a href="../../Paths.scala.html#47762" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#69449" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31479" title="=&gt; String">group</a> <a href="../../Paths.scala.html#47762" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#69449" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31481" title="=&gt; String">module</a> <a href="../../Paths.scala.html#47812" title="(String)java.io.File">/</a> <a href="#69449" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#31483" title="=&gt; String">rev</a>
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="69383">saveDefinitions</a>(): <span title="Unit">Unit</span> = <a href="#69384" title="(java.io.File)Unit">saveDefinitions</a>(<a href="#69353" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Unit" id="69384">saveDefinitions</a>(<a title="java.io.File" id="69491">file</a>: <span title="java.io.File">File</span>): <span title="Unit">Unit</span> = <a href="#69394" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34074" title="(java.io.File)(Iterable[sbt.processor.Definition])Unit">save</a>(<a href="#69491" title="java.io.File">file</a>)(<a href="#69371" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="=&gt; Iterator[sbt.processor.Definition]">values</span>.<span title="=&gt; List[sbt.processor.Definition]">toList</span>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69385">loadDefinitions</a>(<a title="java.io.File" id="69433">file</a>: <span title="java.io.File">File</span>): scala.collection.mutable.<a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="15518">Map</a>[String, Definition] =
		scala.collection.mutable.<a title="((String, sbt.processor.Definition)*)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="15717">HashMap</a>(  (<span title="Seq[(String, sbt.processor.Definition)]" class="keyword">if</span>(<a href="#69433" title="java.io.File">file</a>.<a title="()Boolean" id="16021">exists</a>) <a href="#69386" title="(java.io.File)Seq[(String, sbt.processor.Definition)]">rawLoad</a>(<a href="#69433" title="java.io.File">file</a>) <span class="keyword">else</span> <a title="object Nil" id="310">Nil</a>) : _*)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Seq[(String, sbt.processor.Definition)]" id="69386">rawLoad</a>(<a title="java.io.File" id="69554">file</a>: <span title="java.io.File">File</span>): <a title="Seq[(String, sbt.processor.Definition)]" id="729">Seq</a>[(String, Definition)] = <a href="#69394" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#34075" title="(java.io.File)Seq[sbt.processor.Definition]">load</a>(<a href="#69353" title="=&gt; java.io.File">definitionsFile</a>).<a title="((sbt.processor.Definition) =&gt; (String, sbt.processor.Definition))Seq[(String, sbt.processor.Definition)]" id="16538">map</a> { <a title="sbt.processor.Definition" id="69558">d</a> =&gt; <span title="(String,sbt.processor.Definition)(String, sbt.processor.Definition)">(</span><a href="#69558" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#31472" title="=&gt; String">label</a>, <a href="#69558" title="sbt.processor.Definition">d</a>) }
}
        </pre>
    </body>
</html>