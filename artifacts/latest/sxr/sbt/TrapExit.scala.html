<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/TrapExit.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2008 Mark Harrah
 *
 * Partially based on exit trapping in Nailgun by Pete Kirkham,
 * copyright 2004, Martian Software, Inc
 * licensed under Apache 2.0 License.
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">import</span> scala.collection.Set
<span class="keyword">import</span> scala.reflect.Manifest

<span class="comment">/** This provides functionality to catch System.exit calls to prevent the JVM from terminating.
* This is useful for executing user code that may call System.exit, but actually exiting is
* undesirable.  This file handles the call to exit by disposing all top-level windows and interrupting
* all user started threads.  It does not stop the threads and does not call shutdown hooks.  It is
* therefore inappropriate to use this with code that requires shutdown hooks or creates threads that
* do not terminate.  This category of code should only be called by forking the JVM. */</span>
<span class="keyword">object</span> <a title="object sbt.TrapExit" id="11449">TrapExit</a>
{
	<span class="comment">/** Executes the given thunk in a context where System.exit(code) throws
	* a custom SecurityException, which is then caught and the exit code returned.
	* Otherwise, 0 is returned.  No other exceptions are handled by this method.*/</span>
	<span class="keyword">def</span> <a title="(=&gt; Unit,sbt.Logger)Int" id="73642">apply</a>(<a title="=&gt; Unit" id="73661">execute</a>: =&gt; Unit, <a title="sbt.Logger" id="73662">log</a>: <a href="Logger.scala.html#13533" title="sbt.Logger">Logger</a>): <span title="Int">Int</span> =
	{
		<a href="#73662" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Starting sandboxed run...&quot;)" class="string">&quot;Starting sandboxed run...&quot;</span>)
		
		<span class="comment">/** Take a snapshot of the threads that existed before execution in order to determine
		* the threads that were created by 'execute'.*/</span>
		<span class="keyword">val</span> <a title="scala.collection.Set[java.lang.Thread]" id="76148">originalThreads</a> = <a href="#73651" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>
		<span class="keyword">val</span> <a title="sbt.ExitCode" id="76149">code</a> = <span title="sbt.ExitCode" class="keyword">new</span> <a href="#12717" title="sbt.ExitCode">ExitCode</a>
		<span class="keyword">def</span> <a title="=&gt; Unit" id="76150">executeMain</a> =
			<span class="keyword">try</span> { <a href="#73661" title="=&gt; Unit">execute</a> }
			<span class="keyword">catch</span>
			{
				<span title="Nothing" class="keyword">case</span> <a title="sbt.TrapExitSecurityException" id="76162">e</a>: <a href="#10011" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a> =&gt; <span title="Nothing" class="keyword">throw</span> <a href="#76162" title="sbt.TrapExitSecurityException">e</a>
				<span title="Nothing" class="keyword">case</span> <a title="java.lang.Throwable" id="76184">x</a> =&gt;
					<a href="#76149" title="sbt.ExitCode">code</a>.<a href="#76160" title="(Int)Unit">set</a>(<span title="Int(1)" class="int">1</span>) <span class="comment">//exceptions in the main thread cause the exit code to be 1</span>
					<span title="Nothing" class="keyword">throw</span> <a href="#76184" title="java.lang.Throwable">x</a>
			}
		<span class="keyword">val</span> <a title="sbt.TrapExit.ExitThreadGroup" id="76151">customThreadGroup</a> = <span title="sbt.TrapExit.ExitThreadGroup" class="keyword">new</span> <a href="#73660" title="sbt.TrapExit.ExitThreadGroup">ExitThreadGroup</a>(<span title="sbt.TrapExit.ExitHandler" class="keyword">new</span> <a href="#73659" title="sbt.TrapExit.ExitHandler">ExitHandler</a>(<span title="object java.lang.Thread">Thread</span>.<a title="()java.lang.Thread.UncaughtExceptionHandler" id="59330">getDefaultUncaughtExceptionHandler</a>, <a href="#76148" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#76149" title="sbt.ExitCode">code</a>, <a href="#73662" title="sbt.Logger">log</a>))
		<span class="keyword">val</span> <a title="java.lang.Thread" id="76152">executionThread</a> = <a title="template $anon extends java.lang.Thread" id="76206" class="keyword">new</a> <a title="java.lang.Thread" id="59289">Thread</a>(<a href="#76151" title="sbt.TrapExit.ExitThreadGroup">customThreadGroup</a>, <span title="java.lang.String(&quot;run-main&quot;)" class="string">&quot;run-main&quot;</span>) { <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="76208">run</a>() { <a href="#76150" title="=&gt; Unit">executeMain</a> } }
		
		<span class="keyword">val</span> <a title="java.lang.SecurityManager" id="76153">originalSecurityManager</a> = <span title="object java.lang.System">System</span>.<a title="()java.lang.SecurityManager" id="18114">getSecurityManager</a>
		<span class="keyword">try</span>
		{
			<span class="keyword">val</span> <a title="sbt.TrapExitSecurityManager" id="76278">newSecurityManager</a> = <span title="sbt.TrapExitSecurityManager" class="keyword">new</span> <a href="#11187" title="sbt.TrapExitSecurityManager">TrapExitSecurityManager</a>(<a href="#76153" title="java.lang.SecurityManager">originalSecurityManager</a>, <a href="#76151" title="sbt.TrapExit.ExitThreadGroup">customThreadGroup</a>)
			<span title="object java.lang.System">System</span>.<span title="(java.lang.SecurityManager)Unit">setSecurityManager</span>(<a href="#76278" title="sbt.TrapExitSecurityManager">newSecurityManager</a>)

			<a href="#76152" title="java.lang.Thread">executionThread</a>.<a title="()Unit" id="59293">start</a>()

			<a href="#73662" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Waiting for threads to exit or System.exit to be called.&quot;)" class="string">&quot;Waiting for threads to exit or System.exit to be called.&quot;</span>)
			<a href="#73643" title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit">waitForExit</a>(<a href="#76148" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#73662" title="sbt.Logger">log</a>)
			<a href="#73662" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Interrupting remaining threads (should be all daemons).&quot;)" class="string">&quot;Interrupting remaining threads (should be all daemons).&quot;</span>)
			<a href="#73656" title="(scala.collection.Set[java.lang.Thread])Unit">interruptAll</a>(<a href="#76148" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>) <span class="comment">// should only be daemon threads left now</span>
			<a href="#73662" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Sandboxed run complete..&quot;)" class="string">&quot;Sandboxed run complete..&quot;</span>)
			<a href="#76149" title="sbt.ExitCode">code</a>.<a href="#76161" title="=&gt; Option[Int]">value</a>.<a title="(=&gt; Int)Int" id="30329">getOrElse</a>(<span title="Int(0)" class="int">0</span>)
		}
		<span class="keyword">finally</span> { <span title="object java.lang.System">System</span>.<span title="(java.lang.SecurityManager)Unit">setSecurityManager</span>(<a href="#76153" title="java.lang.SecurityManager">originalSecurityManager</a>) }
	}
	 <span class="comment">// wait for all non-daemon threads to terminate</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit" id="73643">waitForExit</a>(<a title="scala.collection.Set[java.lang.Thread]" id="76293">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="sbt.Logger" id="76294">log</a>: <a href="Logger.scala.html#13533" title="sbt.Logger">Logger</a>)
	{
		<span class="keyword">var</span> <a title="Boolean" id="76301">daemonsOnly</a> = <span title="Boolean(true)" class="keyword">true</span>
		<a href="#73653" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#76293" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a title="java.lang.Thread" id="76305">thread</a> =&gt;
			<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#76305" title="java.lang.Thread">thread</a>.<a title="()Boolean" id="59317">isDaemon</a>)
			{
				<a href="#76301" title="Boolean">daemonsOnly</a> = <span title="Boolean(false)" class="keyword">false</span>
				<a href="#73644" title="(java.lang.Thread,sbt.Logger)Unit">waitOnThread</a>(<a href="#76305" title="java.lang.Thread">thread</a>, <a href="#76294" title="sbt.Logger">log</a>)
			}
		)
		<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#76301" title="Boolean">daemonsOnly</a>)
			<a href="#73643" title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit">waitForExit</a>(<a href="#76293" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#76294" title="sbt.Logger">log</a>)
	}
	<span class="comment">/** Waits for the given thread to exit. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread,sbt.Logger)Unit" id="73644">waitOnThread</a>(<a title="java.lang.Thread" id="76306">thread</a>: <span title="java.lang.Thread">Thread</span>, <a title="sbt.Logger" id="76307">log</a>: <a href="Logger.scala.html#13533" title="sbt.Logger">Logger</a>)
	{
		<a href="#76307" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Waiting for thread &quot;)" class="string">&quot;Waiting for thread &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#76306" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot; to exit&quot;)" class="string">&quot; to exit&quot;</span>)
		<a href="#76306" title="java.lang.Thread">thread</a>.<a title="()Unit" id="59314">join</a>
		<a href="#76307" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49384" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;\011Thread &quot;)" class="string">&quot;\tThread &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#76306" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot; exited.&quot;)" class="string">&quot; exited.&quot;</span>)
	}
	<span class="comment">/** Returns the exit code of the System.exit that caused the given Exception, or rethrows the exception
	* if its cause was not calling System.exit.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Throwable)Int" id="73645">exitCode</a>(<a title="Throwable" id="76311">e</a>: <span title="Throwable">Throwable</span>) =
		<a href="#73646" title="(Throwable)((sbt.TrapExitSecurityException) =&gt; Int)((Throwable) =&gt; Int)(implicit scala.reflect.Manifest[sbt.TrapExitSecurityException])Int">withCause</a>[<a href="#10011" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a>, <span title="Int">Int</span>](<a href="#76311" title="Throwable">e</a>)
			{<a title="sbt.TrapExitSecurityException" id="76318">exited</a> =&gt; <a href="#76318" title="sbt.TrapExitSecurityException">exited</a>.<a href="#79494" title="=&gt; Int">exitCode</a>}
			{<a title="Throwable" id="76320">other</a> =&gt; <span title="Nothing" class="keyword">throw</span> <a href="#76320" title="Throwable">other</a>}
	<span class="comment">/** Recurses into the causes of the given exception looking for a cause of type CauseType.  If one is found, `withType` is called with that cause.
	*  If not, `notType` is called with the root cause.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[CauseType &lt;: Throwable, T](Throwable)((CauseType) =&gt; T)((Throwable) =&gt; T)(implicit scala.reflect.Manifest[CauseType])T" id="73646">withCause</a>[<a title="&gt;: Nothing &lt;: Throwable" id="73649">CauseType</a> &lt;: Throwable, <a title="&gt;: Nothing &lt;: Any" id="73650">T</a>](<a title="Throwable" id="76313">e</a>: <span title="Throwable">Throwable</span>)(<a title="(CauseType) =&gt; T" id="76314">withType</a>: CauseType =&gt; T)(<a title="(Throwable) =&gt; T" id="76315">notType</a>: Throwable =&gt; T)(<span class="keyword">implicit</span> <a title="scala.reflect.Manifest[CauseType]" id="76316">mf</a>: <a title="scala.reflect.Manifest[CauseType]" id="2654">Manifest</a>[CauseType]): <a href="#73650" title="T">T</a> =
	{
		<span class="keyword">val</span> <a title="java.lang.Class[_]" id="76324">clazz</a> = <a href="#76316" title="scala.reflect.Manifest[CauseType]">mf</a>.<a title="=&gt; Class[_]" id="52075">erasure</a>
		<span title="T" class="keyword">if</span>(<a href="#76324" title="java.lang.Class[_]">clazz</a>.<a title="(Any)Boolean" id="3918">isInstance</a>(<a href="#76313" title="Throwable">e</a>))
			<a href="#76314" title="(CauseType)T">withType</a>(<a href="#76313" title="Throwable">e</a>.<a title="CauseType" id="3446">asInstanceOf</a>[<a href="#73649" title="CauseType">CauseType</a>])
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <a title="java.lang.Throwable" id="76327">cause</a> = <a href="#76313" title="Throwable">e</a>.<span title="()java.lang.Throwable">getCause</span>
			<span title="T" class="keyword">if</span>(<a href="#76327" title="java.lang.Throwable">cause</a> <span title="(AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span>)
				<a href="#76315" title="(Throwable)T">notType</a>(<a href="#76313" title="Throwable">e</a>)
			<span class="keyword">else</span>
				<a href="#73646" title="(Throwable)((CauseType) =&gt; T)((Throwable) =&gt; T)(implicit scala.reflect.Manifest[CauseType])T">withCause</a>(<a href="#76327" title="java.lang.Throwable">cause</a>)(<a href="#76314" title="(CauseType) =&gt; T">withType</a>)(<a href="#76315" title="(Throwable) =&gt; T">notType</a>)(<a href="#76316" title="scala.reflect.Manifest[CauseType]">mf</a>)
		}
	}
	
	<span class="comment">/** Returns all threads that are not in the 'system' thread group and are not the AWT implementation
	* thread (AWT-XAWT, AWT-Windows, ...)*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; scala.collection.Set[java.lang.Thread]" id="73651">allThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread] =
	{
		<span class="keyword">val</span> <a title="List[java.lang.Thread]" id="76331">allThreads</a> = wrap.<a href="wrap/Wrappers.scala.html#14839" title="object sbt.wrap.Wrappers">Wrappers</a>.<a href="wrap/Wrappers.scala.html#49468" title="(java.util.Collection[java.lang.Thread])List[java.lang.Thread]">toList</a>(<span title="object java.lang.Thread">Thread</span>.<a title="()java.util.Map[java.lang.Thread,Array[java.lang.StackTraceElement]]" id="59326">getAllStackTraces</a>.<a title="()java.util.Set[java.lang.Thread]" id="40231">keySet</a>)
		<span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[java.lang.Thread]" id="76332">threads</a> = <span title="scala.collection.mutable.HashSet[java.lang.Thread]" class="keyword">new</span> scala.collection.mutable.<a title="scala.collection.mutable.HashSet[java.lang.Thread]" id="20037">HashSet</a>[Thread]
		<span class="keyword">for</span>(<a title="((java.lang.Thread) =&gt; Unit)Unit" id="76359">thread</a> &lt;- <a href="#76331" title="List[java.lang.Thread]">allThreads</a> <span class="keyword">if</span> <span title="=&gt; Boolean">!</span><a href="#73652" title="(java.lang.Thread)Boolean">isSystemThread</a>(<a href="#76359" title="java.lang.Thread">thread</a>))
			<a href="#76332" title="scala.collection.mutable.HashSet[java.lang.Thread]">threads</a> <a title="(java.lang.Thread)Unit" id="30680">+=</a> <a href="#76359" title="java.lang.Thread">thread</a>
		<a href="#76332" title="scala.collection.mutable.HashSet[java.lang.Thread]">threads</a>
	}
	<span class="comment">/** Returns true if the given thread is in the 'system' thread group and is an AWT thread other than
	* AWT-EventQueue or AWT-Shutdown.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread)Boolean" id="73652">isSystemThread</a>(<a title="java.lang.Thread" id="76347">t</a>: <span title="java.lang.Thread">Thread</span>) =
	{
		<span class="keyword">val</span> <a title="java.lang.String" id="76349">name</a> = <a href="#76347" title="java.lang.Thread">t</a>.<span title="()java.lang.String">getName</span>
		<span title="Boolean" class="keyword">if</span>(<a href="#76349" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>))
			<span title="=&gt; Boolean">!</span>(<a href="#76349" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-EventQueue&quot;)" class="string">&quot;AWT-EventQueue&quot;</span>) <span title="(Boolean)Boolean">||</span> <a href="#76349" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-Shutdown&quot;)" class="string">&quot;AWT-Shutdown&quot;</span>))
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <a title="java.lang.ThreadGroup" id="76353">group</a> = <a href="#76347" title="java.lang.Thread">t</a>.<a title="()java.lang.ThreadGroup" id="59308">getThreadGroup</a>
			(<a href="#76353" title="java.lang.ThreadGroup">group</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>) <span title="(Boolean)Boolean">&amp;&amp;</span> (<a href="#76353" title="java.lang.ThreadGroup">group</a>.<a title="()java.lang.String" id="69802">getName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;system&quot;)" class="string">&quot;system&quot;</span>)
		}
	}
	<span class="comment">/** Calls the provided function for each thread in the system as provided by the 
	* allThreads function except those in ignoreThreads.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit" id="73653">processThreads</a>(<a title="scala.collection.Set[java.lang.Thread]" id="76302">ignoreThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="(java.lang.Thread) =&gt; Unit" id="76303">process</a>: Thread =&gt; Unit)
	{
		<a href="#73651" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>.<a title="((java.lang.Thread) =&gt; Boolean)Iterable[java.lang.Thread]" id="15946">filter</a>(<a title="java.lang.Thread" id="76362">thread</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#76302" title="scala.collection.Set[java.lang.Thread]">ignoreThreads</a>.<a title="(java.lang.Thread)Boolean" id="17965">contains</a>(<a href="#76362" title="java.lang.Thread">thread</a>)).<span title="((java.lang.Thread) =&gt; Unit)Unit">foreach</span>(<a href="#76303" title="(java.lang.Thread) =&gt; Unit">process</a>)
	}
	<span class="comment">/** Handles System.exit by disposing all frames and calling interrupt on all user threads */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread])Unit" id="73654">stopAll</a>(<a title="scala.collection.Set[java.lang.Thread]" id="76363">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread])
	{
		<a href="#73655" title="()Unit">disposeAllFrames</a>()
		<a href="#73656" title="(scala.collection.Set[java.lang.Thread])Unit">interruptAll</a>(<a href="#76363" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="73655">disposeAllFrames</a>()
	{
		<span class="keyword">val</span> <a title="Array[java.awt.Frame]" id="76364">allFrames</a> = java.awt.<a title="object java.awt.Frame" id="76594">Frame</a>.<a title="()Array[java.awt.Frame]" id="77372">getFrames</a>
		<span title="Unit" class="keyword">if</span>(<a href="#76364" title="Array[java.awt.Frame]">allFrames</a>.<a title="=&gt; Int" id="15677">length</a> <a title="(Int)Boolean" id="3088">&gt;</a> <span title="Int(0)" class="int">0</span>)
		{
			<a href="#76364" title="Array[java.awt.Frame]">allFrames</a>.<span title="((java.awt.Frame) =&gt; Unit)Unit">foreach</span>(<a href="#77508" title="java.awt.Frame">_</a>.<a title="()Unit" id="78105">dispose</a>) <span class="comment">// dispose all top-level windows, which will cause the AWT-EventQueue-* threads to exit</span>
			<span title="object java.lang.Thread">Thread</span>.<a title="(Long)Unit" id="59283">sleep</a>(<span title="Long(2000L)" class="int">2000</span>) <span class="comment">// AWT Thread doesn't exit immediately, so wait to interrupt it</span>
		}
	}
	<span class="comment">// interrupt all threads that appear to have been started by the user</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread])Unit" id="73656">interruptAll</a>(<a title="scala.collection.Set[java.lang.Thread]" id="76296">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread]): <span title="Unit">Unit</span> =
		<a href="#73653" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#76296" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#73657" title="(java.lang.Thread)Unit">safeInterrupt</a>)
	<span class="comment">// interrupts the given thread, but first replaces the exception handler so that the InterruptedException is not printed</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread)Unit" id="73657">safeInterrupt</a>(<a title="java.lang.Thread" id="79444">thread</a>: <span title="java.lang.Thread">Thread</span>)
	{
		<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#79444" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>))
		{
			<a href="#79444" title="java.lang.Thread">thread</a>.<span title="(java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span>(<span title="sbt.TrapExit.TrapInterrupt" class="keyword">new</span> <a href="#73658" title="sbt.TrapExit.TrapInterrupt">TrapInterrupt</a>(<a href="#79444" title="java.lang.Thread">thread</a>.<a title="()java.lang.Thread.UncaughtExceptionHandler" id="59331">getUncaughtExceptionHandler</a>))
			<a href="#79444" title="java.lang.Thread">thread</a>.<a title="()Unit" id="59297">interrupt</a>
		}
	}
	<span class="comment">// an uncaught exception handler that swallows InterruptedExceptions and otherwise defers to originalHandler</span>
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapInterrupt extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject" id="73658">TrapInterrupt</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="79452">originalHandler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>) <span class="keyword">extends</span> Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>
	{
		<span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="79451">uncaughtException</a>(<a title="java.lang.Thread" id="79455">thread</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="79456">e</a>: <span title="Throwable">Throwable</span>)
		{
			<a href="#73646" title="(Throwable)((java.lang.InterruptedException) =&gt; Unit)((Throwable) =&gt; Unit)(implicit scala.reflect.Manifest[java.lang.InterruptedException])Unit">withCause</a>[<a title="java.lang.InterruptedException" id="1708">InterruptedException</a>, <span title="Unit">Unit</span>](<a href="#79456" title="Throwable">e</a>)
				{<a title="java.lang.InterruptedException" id="79458">interrupted</a> =&gt; <span title="Unit">(</span>)}
				{<a title="Throwable" id="79460">other</a> =&gt; <a href="#79452" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#79455" title="java.lang.Thread">thread</a>, <a href="#79456" title="Throwable">e</a>) }
			<a href="#79455" title="java.lang.Thread">thread</a>.<span title="(java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span>(<a href="#79452" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>)
		}
	}
	<span class="comment">/** An uncaught exception handler that delegates to the original uncaught exception handler except when
	* the cause was a call to System.exit (which generated a SecurityException)*/</span>
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitHandler extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject" id="73659">ExitHandler</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="76202">originalHandler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>, <a title="scala.collection.Set[java.lang.Thread]" id="76203">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="sbt.ExitCode" id="76204">codeHolder</a>: <a href="#12717" title="sbt.ExitCode">ExitCode</a>, <a title="sbt.Logger" id="76205">log</a>: <a href="Logger.scala.html#13533" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>
	{
		<span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="76201">uncaughtException</a>(<a title="java.lang.Thread" id="79468">t</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="79469">e</a>: <span title="Throwable">Throwable</span>)
		{
			<span class="keyword">try</span>
			{
				<a href="#76204" title="sbt.ExitCode">codeHolder</a>.<a href="#76160" title="(Int)Unit">set</a>(<a href="#73645" title="(Throwable)Int">exitCode</a>(<a href="#79469" title="Throwable">e</a>)) <span class="comment">// will rethrow e if it was not because of a call to System.exit</span>
				<a href="#73654" title="(scala.collection.Set[java.lang.Thread])Unit">stopAll</a>(<a href="#76203" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
			}
			<span class="keyword">catch</span>
			{
				<span title="Unit" class="keyword">case</span> _ =&gt;
					<a href="#76205" title="sbt.Logger">log</a>.<a href="Logger.scala.html#49382" title="(=&gt; Throwable)Unit">trace</a>(<a href="#79469" title="Throwable">e</a>)
					<a href="#76202" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#79468" title="java.lang.Thread">t</a>, <a href="#79469" title="Throwable">e</a>)
			}
		}
	}
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitThreadGroup extends java.lang.ThreadGroup with ScalaObject" id="73660">ExitThreadGroup</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="76191">handler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>) <span class="keyword">extends</span> <span title="java.lang.ThreadGroup">ThreadGroup</span>(<span title="java.lang.String(&quot;trap.exit&quot;)" class="string">&quot;trap.exit&quot;</span>)
	{
		<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="76189">uncaughtException</a>(<a title="java.lang.Thread" id="79475">t</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="79476">e</a>: <span title="Throwable">Throwable</span>) = <a href="#76191" title="java.lang.Thread.UncaughtExceptionHandler">handler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#79475" title="java.lang.Thread">t</a>, <a href="#79476" title="Throwable">e</a>)
	}
}
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitCode extends java.lang.Object with NotNull with ScalaObject" id="12717">ExitCode</a> <span class="keyword">extends</span> <a title="NotNull" id="193">NotNull</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[Int]" id="79479">code</a>: <span title="Option[Int]">Option</span>[Int] = <a title="object None" id="509">None</a>
	<span class="keyword">def</span> <a title="(Int)Unit" id="76160">set</a>(<a title="Int" id="76185">c</a>: <span title="Int">Int</span>): <span title="Unit">Unit</span> = <a href="#12717" title="(Unit)Unit">synchronized</a> { <a href="#79479" title="(Option[Int])Unit">code</a> = <a href="#79479" title="=&gt; Option[Int]">code</a> <a title="(=&gt; Option[Int])Option[Int]" id="30337">orElse</a> <a title="(Int)Some[Int]" id="290">Some</a>(<a href="#76185" title="Int">c</a>) }
	<span class="keyword">def</span> <a title="=&gt; Option[Int]" id="76161">value</a>: <span title="Option[Int]">Option</span>[Int] = <a href="#12717" title="(Option[Int])Option[Int]">synchronized</a> { <a href="#79479" title="=&gt; Option[Int]">code</a> }
}
<span class="comment">///////  These two classes are based on similar classes in Nailgun</span>
<span class="comment">/** A custom SecurityManager to disallow System.exit. */</span>
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapExitSecurityManager extends java.lang.SecurityManager with ScalaObject" id="11187">TrapExitSecurityManager</a>(<a title="java.lang.SecurityManager" id="76290">delegateManager</a>: <span title="java.lang.SecurityManager">SecurityManager</span>, <a title="java.lang.ThreadGroup" id="76291">group</a>: <span title="java.lang.ThreadGroup">ThreadGroup</span>) <span class="keyword">extends</span> <span title="java.lang.SecurityManager">SecurityManager</span>
{
	<span class="keyword">import</span> java.security.Permission
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(Int)Unit" id="76285">checkExit</a>(<a title="Int" id="79488">status</a>: <span title="Int">Int</span>)
	{
		<span class="keyword">val</span> <a title="Array[java.lang.StackTraceElement]" id="79489">stack</a> = <span title="object java.lang.Thread">Thread</span>.<a title="()java.lang.Thread" id="59281">currentThread</a>.<a title="()Array[java.lang.StackTraceElement]" id="59323">getStackTrace</a>
		<span title="Unit" class="keyword">if</span>(<a href="#79489" title="Array[java.lang.StackTraceElement]">stack</a> <span title="(AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <span title="(Boolean)Boolean">||</span> <a href="#79489" title="Array[java.lang.StackTraceElement]">stack</a>.<a title="((java.lang.StackTraceElement) =&gt; Boolean)Boolean" id="15954">exists</a>(<a href="#76286" title="(java.lang.StackTraceElement)Boolean">isRealExit</a>))
			<span title="Nothing" class="keyword">throw</span> <span title="sbt.TrapExitSecurityException" class="keyword">new</span> <a href="#10011" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a>(<a href="#79488" title="Int">status</a>)
	}
	<span class="comment">/** This ensures that only actual calls to exit are trapped and not just calls to check if exit is allowed.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.StackTraceElement)Boolean" id="76286">isRealExit</a>(<a title="java.lang.StackTraceElement" id="79491">element</a>: <a title="java.lang.StackTraceElement" id="1798">StackTraceElement</a>): <a title="Boolean" id="2110">Boolean</a> =
		<a href="#79491" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="75173">getClassName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;java.lang.Runtime&quot;)" class="string">&quot;java.lang.Runtime&quot;</span> <span title="(Boolean)Boolean">&amp;&amp;</span> <a href="#79491" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="75174">getMethodName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;exit&quot;)" class="string">&quot;exit&quot;</span>
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission)Unit" id="76287">checkPermission</a>(<a title="java.security.Permission" id="79499">perm</a>: <span title="java.security.Permission">Permission</span>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#76290" title="java.lang.SecurityManager">delegateManager</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>)
			<a href="#76290" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission)Unit" id="76243">checkPermission</a>(<a href="#79499" title="java.security.Permission">perm</a>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission,AnyRef)Unit" id="76288">checkPermission</a>(<a title="java.security.Permission" id="79512">perm</a>: <span title="java.security.Permission">Permission</span>, <a title="AnyRef" id="79513">context</a>: <a title="AnyRef" id="1957">AnyRef</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#76290" title="java.lang.SecurityManager">delegateManager</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>)
			<a href="#76290" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission,Any)Unit" id="76244">checkPermission</a>(<a href="#79512" title="java.security.Permission">perm</a>, <a href="#79513" title="AnyRef">context</a>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.ThreadGroup" id="76289">getThreadGroup</a> = <a href="#76291" title="java.lang.ThreadGroup">group</a>
}
<span class="comment">/** A custom SecurityException that tries not to be caught.*/</span>
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapExitSecurityException extends java.lang.SecurityException with ScalaObject" id="10011">TrapExitSecurityException</a>(<span class="keyword">val</span> <a title="Int" id="79494">exitCode</a>: <span title="Int">Int</span>) <span class="keyword">extends</span> <a title="java.lang.SecurityException" id="1801">SecurityException</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="79524">accessAllowed</a> = <span title="Boolean(false)" class="keyword">false</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="76174">allowAccess</a>
	{
		<a href="#79524" title="(Boolean)Unit">accessAllowed</a> = <span title="Boolean(true)" class="keyword">true</span>
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="76175">printStackTrace</a> = <a href="#76181" title="(=&gt; Unit)Unit">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()Unit" id="17834">printStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="76176">toString</a> = <a href="#76181" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17833">toString</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="76177">getCause</a> = <a href="#76181" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<span title="()java.lang.Throwable">getCause</span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="76178">getMessage</a> = <a href="#76181" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17829">getMessage</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="76179">fillInStackTrace</a> = <a href="#76181" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.Throwable" id="17837">fillInStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="76180">getLocalizedMessage</a> = <a href="#76181" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17830">getLocalizedMessage</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T](=&gt; T)T" id="76181">ifAccessAllowed</a>[<a title="&gt;: Nothing &lt;: Any" id="76183">T</a>](<a title="=&gt; T" id="79534">f</a>: =&gt; T): <a href="#76183" title="T">T</a> =
	{
		<span title="T" class="keyword">if</span>(<a href="#79524" title="=&gt; Boolean">accessAllowed</a>)
			<a href="#79534" title="=&gt; T">f</a>
		<span class="keyword">else</span>
			<span title="Nothing" class="keyword">throw</span> <a href="#10011" title="sbt.TrapExitSecurityException" class="keyword">this</a>
	}
}
        </pre>
    </body>
</html>