<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/processor/Manager.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2010  Mark Harrah
 */</span>
<span class="keyword">package</span> sbt.processor

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> xsbt.Paths._
<span class="keyword">import</span> ProcessorException.error

<span class="comment">/** Files needed by ManagerImpl.
* `retrieveBaseDirectory` is the directory that processors are retrieved under.
* `retrieveLockFile` is used to synchronize access to that directory.
* `definitionsFile` is the file to save repository and processor definitions to.  It is usually per-user instead of per-project.*/</span>
<span class="keyword">class</span> <a title="class ManagerFiles extends java.lang.Object with ScalaObject" id="14668">ManagerFiles</a>(<span class="keyword">val</span> <a title="java.io.File" id="66709">retrieveBaseDirectory</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="66710">retrieveLockFile</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="66711">definitionsFile</a>: <span title="java.io.File">File</span>)

<span class="keyword">class</span> <a title="class ManagerImpl extends java.lang.Object with sbt.processor.Manager with ScalaObject" id="14782">ManagerImpl</a>(<a title="sbt.processor.ManagerFiles" id="66687">files</a>: <a href="#14668" title="sbt.processor.ManagerFiles">ManagerFiles</a>, <a title="String" id="66688">scalaVersion</a>: <span title="String">String</span>, <a title="sbt.processor.Persist" id="66689">persist</a>: <a href="Persist.scala.html#14719" title="sbt.processor.Persist">Persist</a>, <a title="Boolean" id="66690">localOnly</a>: <span title="Boolean">Boolean</span>, <a title="sbt.Logger" id="66691">log</a>: <a href="../Logger.scala.html#13533" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> <a href="Processor.scala.html#14602" title="sbt.processor.Manager">Manager</a>
{
	<span class="keyword">import</span> files._
	
	<span class="keyword">def</span> <a title="(String)Option[sbt.processor.ProcessorDefinition]" id="66664">processorDefinition</a>(<a title="String" id="84853">label</a>: <span title="String">String</span>): <span title="Option[sbt.processor.ProcessorDefinition]">Option</span>[ProcessorDefinition] = <a href="#66674" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">processors</a>.<span title="(String)Option[sbt.processor.ProcessorDefinition]">get</span>(<a href="#84853" title="String">label</a>)
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Option[sbt.processor.Processor]" id="66665">processor</a>(<a title="sbt.processor.ProcessorDefinition" id="84856">pdef</a>: <a href="Processor.scala.html#14605" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>): <span title="Option[sbt.processor.Processor]">Option</span>[Processor] =
	{
		<span class="keyword">def</span> <a title="=&gt; Either[Throwable,sbt.processor.Processor]" id="85187">tryProcessor</a>: <a title="Either[Throwable,sbt.processor.Processor]" id="340">Either</a>[Throwable, Processor] =
			(<span title="sbt.processor.Loader" class="keyword">new</span> <a href="Loader.scala.html#14761" title="sbt.processor.Loader">Loader</a>).<a href="Loader.scala.html#84967" title="(java.io.File)Either[Throwable,sbt.processor.Processor]">getProcessor</a>( <a href="#66682" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#84856" title="sbt.processor.ProcessorDefinition">pdef</a>) )

		 <span class="comment">// try to load the processor.  It will succeed here if the processor has already been retrieved</span>
		<a href="#85187" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Either[Unit,sbt.processor.Processor])Either[Unit,sbt.processor.Processor]" id="50279">flatMap</a> { <a title="Throwable" id="85208">_</a> =&gt;
			 <span class="comment">// if it hasn't been retrieved, retrieve the processor and its dependencies</span>
			<a href="#66669" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#84856" title="sbt.processor.ProcessorDefinition">pdef</a>, <a href="#66690" title="Boolean">localOnly</a>)
			<span class="comment">// try to load the processor now that it has been retrieved</span>
			<a href="#85187" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Unit)Either[Unit,sbt.processor.Processor] with Product" id="50282">map</a> <a href="#85217" title="Unit">{</a> <span class="comment">// if that fails, log a warning</span>
				<span title="Unit" class="keyword">case</span> <a title="sbt.processor.ProcessorException" id="85218">p</a>: <a href="Processor.scala.html#14689" title="sbt.processor.ProcessorException">ProcessorException</a> =&gt; <a href="#66691" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#49386" title="(=&gt; String)Unit">warn</a>(<a href="#85218" title="sbt.processor.ProcessorException">p</a>.<a title="()java.lang.String" id="17829">getMessage</a>)
				<span title="Unit" class="keyword">case</span> <a title="Throwable" id="85220">t</a> =&gt; <a href="#66691" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#49382" title="(=&gt; Throwable)Unit">trace</a>(<a href="#85220" title="Throwable">t</a>); <a href="#66691" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#49386" title="(=&gt; String)Unit">warn</a>(<a href="#85220" title="Throwable">t</a>.<a title="()java.lang.String" id="17833">toString</a>)
			}
		}.<a title="=&gt; Either.RightProjection[Unit,sbt.processor.Processor]" id="50352">right</a>.<a title="=&gt; Option[sbt.processor.Processor]" id="50324">toOption</a>
	}
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Unit" id="66666">defineProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="85225">p</a>: <a href="Processor.scala.html#14605" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>)
	{
		<a href="#66675" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#85225" title="sbt.processor.ProcessorDefinition">p</a>)
		<a href="#66669" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#85225" title="sbt.processor.ProcessorDefinition">p</a>, <a href="#66690" title="Boolean">localOnly</a>)
		<a href="#66670" title="(sbt.processor.Definition)Unit">add</a>(<a href="#85225" title="sbt.processor.ProcessorDefinition">p</a>)
	}
	<span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)Unit" id="66667">defineRepository</a>(<a title="sbt.processor.RepositoryDefinition" id="85228">r</a>: <a href="Processor.scala.html#14620" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>)
	{
		<a href="#66675" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#85228" title="sbt.processor.RepositoryDefinition">r</a>)
		<a href="#66670" title="(sbt.processor.Definition)Unit">add</a>(<a href="#85228" title="sbt.processor.RepositoryDefinition">r</a>)
	}
	<span class="keyword">def</span> <a title="(String)sbt.processor.Definition" id="66668">removeDefinition</a>(<a title="String" id="85229">label</a>: <span title="String">String</span>): <a href="Processor.scala.html#14662" title="sbt.processor.Definition">Definition</a> =
		<a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<a title="(String)Option[sbt.processor.Definition]" id="37798">removeKey</a>(<a href="#85229" title="String">label</a>) <span title="sbt.processor.Definition" class="keyword">match</span>
		{
			<span title="sbt.processor.Definition" class="keyword">case</span> Some(<a title="sbt.processor.Definition" id="85230">removed</a>) =&gt;
				<a href="#66683" title="()Unit">saveDefinitions</a>()
				<a href="#85230" title="sbt.processor.Definition">removed</a>
			<span title="Nothing" class="keyword">case</span> <a title="object None" id="509">None</a> =&gt; <a href="Processor.scala.html#66693" title="(String)Nothing">error</a>(<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#85229" title="String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' not defined.&quot;)" class="string">&quot;' not defined.&quot;</span>)
		}
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition,Boolean)Unit" id="66669">retrieveProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="85209">p</a>: <a href="Processor.scala.html#14605" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>, <a title="Boolean" id="85210">localOnly</a>: <span title="Boolean">Boolean</span>): <span title="Unit">Unit</span> =
	{
		<span class="keyword">val</span> <a title="List[sbt.Resolver]" id="85242">resolvers</a> = <a href="#66673" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">repositories</a>.<span title="=&gt; Iterator[sbt.processor.RepositoryDefinition]">values</span>.<span title="=&gt; List[sbt.processor.RepositoryDefinition]">toList</span>.<a title="((sbt.processor.RepositoryDefinition) =&gt; sbt.Resolver)List[sbt.Resolver]" id="15531">map</a>(<a href="#66681" title="(sbt.processor.RepositoryDefinition)sbt.Resolver">toResolver</a>)
		<span class="keyword">val</span> <a title="sbt.ModuleID" id="85243">module</a> = <a href="#85209" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#84813" title="(String)sbt.ModuleID">toModuleID</a>(<a href="#66688" title="String">scalaVersion</a>)
		( <span title="sbt.processor.Retrieve" class="keyword">new</span> <a href="Retrieve.scala.html#14758" title="sbt.processor.Retrieve">Retrieve</a>(<a href="#66682" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#85209" title="sbt.processor.ProcessorDefinition">p</a>), <a href="#85243" title="sbt.ModuleID">module</a>, <a href="#66689" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#66735" title="=&gt; xsbti.GlobalLock">lock</a>, <a href="#66710" title="=&gt; java.io.File">retrieveLockFile</a>, <a href="#85242" title="List[sbt.Resolver]">resolvers</a>, <a href="#66691" title="sbt.Logger">log</a>) ).<a href="Retrieve.scala.html#85307" title="(Boolean)Unit">retrieve</a>(<a href="#85210" title="Boolean">localOnly</a>)
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="66670">add</a>(<a title="sbt.processor.Definition" id="85227">d</a>: <a href="Processor.scala.html#14662" title="sbt.processor.Definition">Definition</a>)
	{
		<a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>(<a href="#85227" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#84782" title="=&gt; String">label</a>) = <a href="#85227" title="sbt.processor.Definition">d</a>
		<a href="#66683" title="()Unit">saveDefinitions</a>()
	}

	<span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="66672">definitions</a> = <a href="#66685" title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]">loadDefinitions</a>(<a href="#66711" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]" id="66673">repositories</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.RepositoryDefinition)])scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">++</span> <a href="#66676" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.RepositoryDefinition)])Iterable[(String, sbt.processor.RepositoryDefinition)]">partialMap</a>(<a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#85272" title="(String, sbt.processor.RepositoryDefinition)">{</a> <span title="(String, sbt.processor.RepositoryDefinition)" class="keyword">case</span> (<a title="String" id="85273">label</a>, <a title="sbt.processor.RepositoryDefinition" id="85274">d</a>: <a href="Processor.scala.html#14620" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>) =&gt; <span title="(String,sbt.processor.RepositoryDefinition)(String, sbt.processor.RepositoryDefinition)">(</span><a href="#85273" title="String">label</a>, <a href="#85274" title="sbt.processor.RepositoryDefinition">d</a>) }
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]" id="66674">processors</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.ProcessorDefinition)])scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">++</span> <a href="#66676" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.ProcessorDefinition)])Iterable[(String, sbt.processor.ProcessorDefinition)]">partialMap</a>(<a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#85176" title="(String, sbt.processor.ProcessorDefinition)">{</a> <span title="(String, sbt.processor.ProcessorDefinition)" class="keyword">case</span> (<a title="String" id="85177">label</a>, <a title="sbt.processor.ProcessorDefinition" id="85178">p</a>: <a href="Processor.scala.html#14605" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) =&gt; <span title="(String,sbt.processor.ProcessorDefinition)(String, sbt.processor.ProcessorDefinition)">(</span><a href="#85177" title="String">label</a>, <a href="#85178" title="sbt.processor.ProcessorDefinition">p</a>) }
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="66675">checkExisting</a>(<a title="sbt.processor.Definition" id="85226">p</a>: <a href="Processor.scala.html#14662" title="sbt.processor.Definition">Definition</a>): <span title="Unit">Unit</span>  =  <a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="(String)Option[sbt.processor.Definition]">get</span>(<a href="#85226" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#84782" title="=&gt; String">label</a>) <a title="((sbt.processor.Definition) =&gt; Nothing)Option[Nothing]" id="30331">map</a> { <a title="sbt.processor.Definition" id="85324">d</a> =&gt; <a href="Processor.scala.html#66693" title="(String)Nothing">error</a> (<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#85226" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#84782" title="=&gt; String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' already in use: &quot;)" class="string">&quot;' already in use: &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#85324" title="sbt.processor.Definition">d</a>) }
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T, S](Iterable[T])(PartialFunction[T,S])Iterable[S]" id="66676">partialMap</a>[<a title="&gt;: Nothing &lt;: Any" id="66679">T</a>,<a title="&gt;: Nothing &lt;: Any" id="66680">S</a>](<a title="Iterable[T]" id="85166">i</a>: <a title="Iterable[T]" id="376">Iterable</a>[T])(<a title="PartialFunction[T,S]" id="85167">f</a>: <a title="PartialFunction[T,S]" id="1249">PartialFunction</a>[T,S]) = <a href="#85166" title="Iterable[T]">i</a>.<a title="((T) =&gt; Boolean)Iterable[T]" id="15946">filter</a>(<a href="#85167" title="PartialFunction[T,S]">f</a>.<a href="#85170" title="(T)Boolean" id="15910">isDefinedAt</a>).<a title="((T) =&gt; S)Iterable[S]" id="15942">map</a>(<a href="#85167" title="PartialFunction[T,S]">f</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)sbt.Resolver" id="66681">toResolver</a>(<a title="sbt.processor.RepositoryDefinition" id="85285">repo</a>: <a href="Processor.scala.html#14620" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>): <a href="../../IvyInterface.scala.html#12834" title="sbt.Resolver">Resolver</a> = <span title="sbt.MavenRepository" class="keyword">new</span> <a href="../../IvyInterface.scala.html#10068" title="sbt.MavenRepository">MavenRepository</a>(<a href="#85285" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#84785" title="=&gt; String">label</a>, <a href="#85285" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#84787" title="=&gt; String">url</a>)

	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)java.io.File" id="66682">retrieveDirectory</a>(<a title="sbt.processor.ProcessorDefinition" id="85189">p</a>: <a href="Processor.scala.html#14605" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) = <a href="../../Paths.scala.html#20622" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">retrieveBaseDirectory</a> <a href="../../Paths.scala.html#20622" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#85189" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#84804" title="=&gt; String">group</a> <a href="../../Paths.scala.html#20622" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#85189" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#84806" title="=&gt; String">module</a> <a href="../../Paths.scala.html#20670" title="(String)java.io.File">/</a> <a href="#85189" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#84808" title="=&gt; String">rev</a>
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="66683">saveDefinitions</a>(): <span title="Unit">Unit</span> = <a href="#66684" title="(java.io.File)Unit">saveDefinitions</a>(<a href="#66711" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Unit" id="66684">saveDefinitions</a>(<a title="java.io.File" id="85232">file</a>: <span title="java.io.File">File</span>): <span title="Unit">Unit</span> = <a href="#66689" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#66743" title="(java.io.File)(Iterable[sbt.processor.Definition])Unit">save</a>(<a href="#85232" title="java.io.File">file</a>)(<a href="#66671" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="=&gt; Iterator[sbt.processor.Definition]">values</span>.<span title="=&gt; List[sbt.processor.Definition]">toList</span>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="66685">loadDefinitions</a>(<a title="java.io.File" id="85174">file</a>: <span title="java.io.File">File</span>): scala.collection.mutable.<a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="20022">Map</a>[String, Definition] =
		scala.collection.mutable.<a title="((String, sbt.processor.Definition)*)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="20221">HashMap</a>(  (<span title="Seq[(String, sbt.processor.Definition)]" class="keyword">if</span>(<a href="#85174" title="java.io.File">file</a>.<a title="()Boolean" id="16772">exists</a>) <a href="#66686" title="(java.io.File)Seq[(String, sbt.processor.Definition)]">rawLoad</a>(<a href="#85174" title="java.io.File">file</a>) <span class="keyword">else</span> <a title="object Nil" id="314">Nil</a>) : _*)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Seq[(String, sbt.processor.Definition)]" id="66686">rawLoad</a>(<a title="java.io.File" id="85333">file</a>: <span title="java.io.File">File</span>): <a title="Seq[(String, sbt.processor.Definition)]" id="733">Seq</a>[(String, Definition)] = <a href="#66689" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#66744" title="(java.io.File)Seq[sbt.processor.Definition]">load</a>(<a href="#66711" title="=&gt; java.io.File">definitionsFile</a>).<a title="((sbt.processor.Definition) =&gt; (String, sbt.processor.Definition))Seq[(String, sbt.processor.Definition)]" id="15820">map</a> { <a title="sbt.processor.Definition" id="85339">d</a> =&gt; <span title="(String,sbt.processor.Definition)(String, sbt.processor.Definition)">(</span><a href="#85339" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#84782" title="=&gt; String">label</a>, <a href="#85339" title="sbt.processor.Definition">d</a>) }
}
        </pre>
    </body>
</html>