<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/TrapExit.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2008 Mark Harrah
 *
 * Partially based on exit trapping in Nailgun by Pete Kirkham,
 * copyright 2004, Martian Software, Inc
 * licensed under Apache 2.0 License.
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">import</span> scala.collection.Set
<span class="keyword">import</span> scala.reflect.Manifest

<span class="comment">/** This provides functionality to catch System.exit calls to prevent the JVM from terminating.
* This is useful for executing user code that may call System.exit, but actually exiting is
* undesirable.  This file handles the call to exit by disposing all top-level windows and interrupting
* all user started threads.  It does not stop the threads and does not call shutdown hooks.  It is
* therefore inappropriate to use this with code that requires shutdown hooks or creates threads that
* do not terminate.  This category of code should only be called by forking the JVM. */</span>
<span class="keyword">object</span> <a title="object sbt.TrapExit" id="9748">TrapExit</a>
{
	<span class="comment">/** Executes the given thunk in a context where System.exit(code) throws
	* a custom SecurityException, which is then caught and the exit code returned.
	* Otherwise, 0 is returned.  No other exceptions are handled by this method.*/</span>
	<span class="keyword">def</span> <a title="(=&gt; Unit,sbt.Logger)Int" id="62683">apply</a>(<a title="=&gt; Unit" id="62703">execute</a>: =&gt; Unit, <a title="sbt.Logger" id="62704">log</a>: <a href="Logger.scala.html#11784" title="sbt.Logger">Logger</a>): <span title="Int">Int</span> =
	{
		<a href="#62704" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Starting sandboxed run...&quot;)" class="string">&quot;Starting sandboxed run...&quot;</span>)
		
		<span class="comment">/** Take a snapshot of the threads that existed before execution in order to determine
		* the threads that were created by 'execute'.*/</span>
		<span class="keyword">val</span> <a title="scala.collection.Set[java.lang.Thread]" id="62705">originalThreads</a> = <a href="#62692" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>
		<span class="keyword">val</span> <a title="sbt.ExitCode" id="62706">code</a> = <span title="sbt.ExitCode" class="keyword">new</span> <a href="#10998" title="sbt.ExitCode">ExitCode</a>
		<span class="keyword">def</span> <a title="=&gt; Unit" id="62707">executeMain</a> =
			<span class="keyword">try</span> { <a href="#62703" title="=&gt; Unit">execute</a> }
			<span class="keyword">catch</span>
			{
				<span title="Nothing" class="keyword">case</span> <a title="sbt.TrapExitSecurityException" id="62719">e</a>: <a href="#8358" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a> =&gt; <span title="Nothing" class="keyword">throw</span> <a href="#62719" title="sbt.TrapExitSecurityException">e</a>
				<span title="Nothing" class="keyword">case</span> <a title="java.lang.Throwable" id="62741">x</a> =&gt;
					<a href="#62706" title="sbt.ExitCode">code</a>.<a href="#62717" title="(Int)Unit">set</a>(<span title="Int(1)" class="int">1</span>) <span class="comment">//exceptions in the main thread cause the exit code to be 1</span>
					<span title="Nothing" class="keyword">throw</span> <a href="#62741" title="java.lang.Throwable">x</a>
			}
		<span class="keyword">val</span> <a title="sbt.TrapExit.ExitThreadGroup" id="62708">customThreadGroup</a> = <span title="sbt.TrapExit.ExitThreadGroup" class="keyword">new</span> <a href="#62701" title="sbt.TrapExit.ExitThreadGroup">ExitThreadGroup</a>(<span title="sbt.TrapExit.ExitHandler" class="keyword">new</span> <a href="#62700" title="sbt.TrapExit.ExitHandler">ExitHandler</a>(<span title="object java.lang.Thread">Thread</span>.<a title="()java.lang.Thread.UncaughtExceptionHandler" id="33143">getDefaultUncaughtExceptionHandler</a>, <a href="#62705" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#62706" title="sbt.ExitCode">code</a>, <a href="#62704" title="sbt.Logger">log</a>))
		<span class="keyword">val</span> <a title="java.lang.Thread" id="62709">executionThread</a> = <a title="template $anon extends java.lang.Thread" id="62804" class="keyword">new</a> <a title="java.lang.Thread" id="33102">Thread</a>(<a href="#62708" title="sbt.TrapExit.ExitThreadGroup">customThreadGroup</a>, <span title="java.lang.String(&quot;run-main&quot;)" class="string">&quot;run-main&quot;</span>) { <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="62806">run</a>() { <a href="#62707" title="=&gt; Unit">executeMain</a> } }
		
		<span class="keyword">val</span> <a title="java.lang.SecurityManager" id="62710">originalSecurityManager</a> = <span title="object java.lang.System">System</span>.<a title="()java.lang.SecurityManager" id="34090">getSecurityManager</a>
		<span class="keyword">try</span>
		{
			<span class="keyword">val</span> <a title="sbt.TrapExitSecurityManager" id="62876">newSecurityManager</a> = <span title="sbt.TrapExitSecurityManager" class="keyword">new</span> <a href="#9501" title="sbt.TrapExitSecurityManager">TrapExitSecurityManager</a>(<a href="#62710" title="java.lang.SecurityManager">originalSecurityManager</a>, <a href="#62708" title="sbt.TrapExit.ExitThreadGroup">customThreadGroup</a>)
			<span title="object java.lang.System">System</span>.<span title="(java.lang.SecurityManager)Unit">setSecurityManager</span>(<a href="#62876" title="sbt.TrapExitSecurityManager">newSecurityManager</a>)

			<a href="#62709" title="java.lang.Thread">executionThread</a>.<a title="()Unit" id="33106">start</a>()

			<a href="#62704" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Waiting for threads to exit or System.exit to be called.&quot;)" class="string">&quot;Waiting for threads to exit or System.exit to be called.&quot;</span>)
			<a href="#62684" title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit">waitForExit</a>(<a href="#62705" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#62704" title="sbt.Logger">log</a>)
			<a href="#62704" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Interrupting remaining threads (should be all daemons).&quot;)" class="string">&quot;Interrupting remaining threads (should be all daemons).&quot;</span>)
			<a href="#62697" title="(scala.collection.Set[java.lang.Thread])Unit">interruptAll</a>(<a href="#62705" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>) <span class="comment">// should only be daemon threads left now</span>
			<a href="#62704" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Sandboxed run complete..&quot;)" class="string">&quot;Sandboxed run complete..&quot;</span>)
			<a href="#62706" title="sbt.ExitCode">code</a>.<a href="#62718" title="=&gt; Option[Int]">value</a>.<a title="(=&gt; Int)Int" id="19015">getOrElse</a>(<span title="Int(0)" class="int">0</span>)
		}
		<span class="keyword">finally</span> { <span title="object java.lang.System">System</span>.<span title="(java.lang.SecurityManager)Unit">setSecurityManager</span>(<a href="#62710" title="java.lang.SecurityManager">originalSecurityManager</a>) }
	}
	 <span class="comment">// wait for all non-daemon threads to terminate</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit" id="62684">waitForExit</a>(<a title="scala.collection.Set[java.lang.Thread]" id="62891">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="sbt.Logger" id="62892">log</a>: <a href="Logger.scala.html#11784" title="sbt.Logger">Logger</a>)
	{
		<span class="keyword">var</span> <a title="Boolean" id="62899">daemonsOnly</a> = <span title="Boolean(true)" class="keyword">true</span>
		<a href="#62694" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#62891" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a title="java.lang.Thread" id="62903">thread</a> =&gt;
			<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#62903" title="java.lang.Thread">thread</a>.<a title="()Boolean" id="33130">isDaemon</a>)
			{
				<a href="#62899" title="Boolean">daemonsOnly</a> = <span title="Boolean(false)" class="keyword">false</span>
				<a href="#62685" title="(java.lang.Thread,sbt.Logger)Unit">waitOnThread</a>(<a href="#62903" title="java.lang.Thread">thread</a>, <a href="#62892" title="sbt.Logger">log</a>)
			}
		)
		<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#62899" title="Boolean">daemonsOnly</a>)
			<a href="#62684" title="(scala.collection.Set[java.lang.Thread],sbt.Logger)Unit">waitForExit</a>(<a href="#62891" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#62892" title="sbt.Logger">log</a>)
	}
	<span class="comment">/** Waits for the given thread to exit. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread,sbt.Logger)Unit" id="62685">waitOnThread</a>(<a title="java.lang.Thread" id="62904">thread</a>: <span title="java.lang.Thread">Thread</span>, <a title="sbt.Logger" id="62905">log</a>: <a href="Logger.scala.html#11784" title="sbt.Logger">Logger</a>)
	{
		<a href="#62905" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Waiting for thread &quot;)" class="string">&quot;Waiting for thread &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#62904" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot; to exit&quot;)" class="string">&quot; to exit&quot;</span>)
		<a href="#62904" title="java.lang.Thread">thread</a>.<a title="()Unit" id="33127">join</a>
		<a href="#62905" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19516" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;\011Thread &quot;)" class="string">&quot;\tThread &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#62904" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot; exited.&quot;)" class="string">&quot; exited.&quot;</span>)
	}
	<span class="comment">/** Returns the exit code of the System.exit that caused the given Exception, or rethrows the exception
	* if its cause was not calling System.exit.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Throwable)Int" id="62686">exitCode</a>(<a title="Throwable" id="62909">e</a>: <span title="Throwable">Throwable</span>) =
		<a href="#62687" title="(Throwable)((sbt.TrapExitSecurityException) =&gt; Int)((Throwable) =&gt; Int)(implicit scala.reflect.Manifest[sbt.TrapExitSecurityException])Int">withCause</a>[<a href="#8358" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a>, <span title="Int">Int</span>](<a href="#62909" title="Throwable">e</a>)
			{<a title="sbt.TrapExitSecurityException" id="62916">exited</a> =&gt; <a href="#62916" title="sbt.TrapExitSecurityException">exited</a>.<a href="#64776" title="=&gt; Int">exitCode</a>}
			{<a title="Throwable" id="62918">other</a> =&gt; <span title="Nothing" class="keyword">throw</span> <a href="#62918" title="Throwable">other</a>}
	<span class="comment">/** Recurses into the causes of the given exception looking for a cause of type CauseType.  If one is found, `withType` is called with that cause.
	*  If not, `notType` is called with the root cause.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[CauseType &lt;: Throwable, T](Throwable)((CauseType) =&gt; T)((Throwable) =&gt; T)(implicit scala.reflect.Manifest[CauseType])T" id="62687">withCause</a>[<a title="&gt;: Nothing &lt;: Throwable" id="62690">CauseType</a> &lt;: Throwable, <a title="&gt;: Nothing &lt;: Any" id="62691">T</a>](<a title="Throwable" id="62911">e</a>: <span title="Throwable">Throwable</span>)(<a title="(CauseType) =&gt; T" id="62912">withType</a>: CauseType =&gt; T)(<a title="(Throwable) =&gt; T" id="62913">notType</a>: Throwable =&gt; T)(<span class="keyword">implicit</span> <a title="scala.reflect.Manifest[CauseType]" id="62914">mf</a>: <a title="scala.reflect.Manifest[CauseType]" id="2659">Manifest</a>[CauseType]): <a href="#62691" title="T">T</a> =
	{
		<span class="keyword">val</span> <a title="java.lang.Class[_]" id="62922">clazz</a> = <a href="#62914" title="scala.reflect.Manifest[CauseType]">mf</a>.<a title="=&gt; Class[_]" id="18871">erasure</a>
		<span title="T" class="keyword">if</span>(<a href="#62922" title="java.lang.Class[_]">clazz</a>.<a title="(Any)Boolean" id="3890">isInstance</a>(<a href="#62911" title="Throwable">e</a>))
			<a href="#62912" title="(CauseType)T">withType</a>(<a href="#62911" title="Throwable">e</a>.<a title="CauseType" id="3451">asInstanceOf</a>[<a href="#62690" title="CauseType">CauseType</a>])
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <a title="java.lang.Throwable" id="62925">cause</a> = <a href="#62911" title="Throwable">e</a>.<span title="()java.lang.Throwable">getCause</span>
			<span title="T" class="keyword">if</span>(<a href="#62925" title="java.lang.Throwable">cause</a> <span title="(AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span>)
				<a href="#62913" title="(Throwable)T">notType</a>(<a href="#62911" title="Throwable">e</a>)
			<span class="keyword">else</span>
				<a href="#62687" title="(Throwable)((CauseType) =&gt; T)((Throwable) =&gt; T)(implicit scala.reflect.Manifest[CauseType])T">withCause</a>(<a href="#62925" title="java.lang.Throwable">cause</a>)(<a href="#62912" title="(CauseType) =&gt; T">withType</a>)(<a href="#62913" title="(Throwable) =&gt; T">notType</a>)(<a href="#62914" title="scala.reflect.Manifest[CauseType]">mf</a>)
		}
	}
	
	<span class="comment">/** Returns all threads that are not in the 'system' thread group and are not the AWT implementation
	* thread (AWT-XAWT, AWT-Windows, ...)*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; scala.collection.Set[java.lang.Thread]" id="62692">allThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread] =
	{
		<span class="keyword">val</span> <a title="List[java.lang.Thread]" id="62929">allThreads</a> = wrap.<a href="wrap/Wrappers.scala.html#14084" title="object sbt.wrap.Wrappers">Wrappers</a>.<a href="wrap/Wrappers.scala.html#18037" title="(java.util.Collection[java.lang.Thread])List[java.lang.Thread]">toList</a>(<span title="object java.lang.Thread">Thread</span>.<a title="()java.util.Map[java.lang.Thread,Array[java.lang.StackTraceElement]]" id="33139">getAllStackTraces</a>.<a title="()java.util.Set[java.lang.Thread]" id="18091">keySet</a>)
		<span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[java.lang.Thread]" id="62930">threads</a> = <span title="scala.collection.mutable.HashSet[java.lang.Thread]" class="keyword">new</span> scala.collection.mutable.<a title="scala.collection.mutable.HashSet[java.lang.Thread]" id="15533">HashSet</a>[Thread]
		<span class="keyword">for</span>(<a title="((java.lang.Thread) =&gt; Unit)Unit" id="62957">thread</a> &lt;- <a href="#62929" title="List[java.lang.Thread]">allThreads</a> <span class="keyword">if</span> <span title="=&gt; Boolean">!</span><a href="#62693" title="(java.lang.Thread)Boolean">isSystemThread</a>(<a href="#62957" title="java.lang.Thread">thread</a>))
			<a href="#62930" title="scala.collection.mutable.HashSet[java.lang.Thread]">threads</a> <a title="(java.lang.Thread)Unit" id="17898">+=</a> <a href="#62957" title="java.lang.Thread">thread</a>
		<a href="#62930" title="scala.collection.mutable.HashSet[java.lang.Thread]">threads</a>
	}
	<span class="comment">/** Returns true if the given thread is in the 'system' thread group and is an AWT thread other than
	* AWT-EventQueue or AWT-Shutdown.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread)Boolean" id="62693">isSystemThread</a>(<a title="java.lang.Thread" id="62945">t</a>: <span title="java.lang.Thread">Thread</span>) =
	{
		<span class="keyword">val</span> <a title="java.lang.String" id="62947">name</a> = <a href="#62945" title="java.lang.Thread">t</a>.<span title="()java.lang.String">getName</span>
		<span title="Boolean" class="keyword">if</span>(<a href="#62947" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>))
			<span title="=&gt; Boolean">!</span>(<a href="#62947" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-EventQueue&quot;)" class="string">&quot;AWT-EventQueue&quot;</span>) <span title="(Boolean)Boolean">||</span> <a href="#62947" title="java.lang.String">name</a>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-Shutdown&quot;)" class="string">&quot;AWT-Shutdown&quot;</span>))
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <a title="java.lang.ThreadGroup" id="62951">group</a> = <a href="#62945" title="java.lang.Thread">t</a>.<a title="()java.lang.ThreadGroup" id="33121">getThreadGroup</a>
			(<a href="#62951" title="java.lang.ThreadGroup">group</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>) <span title="(Boolean)Boolean">&amp;&amp;</span> (<a href="#62951" title="java.lang.ThreadGroup">group</a>.<a title="()java.lang.String" id="62756">getName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;system&quot;)" class="string">&quot;system&quot;</span>)
		}
	}
	<span class="comment">/** Calls the provided function for each thread in the system as provided by the 
	* allThreads function except those in ignoreThreads.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit" id="62694">processThreads</a>(<a title="scala.collection.Set[java.lang.Thread]" id="62900">ignoreThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="(java.lang.Thread) =&gt; Unit" id="62901">process</a>: Thread =&gt; Unit)
	{
		<a href="#62692" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>.<a title="((java.lang.Thread) =&gt; Boolean)Iterable[java.lang.Thread]" id="16064">filter</a>(<a title="java.lang.Thread" id="62960">thread</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#62900" title="scala.collection.Set[java.lang.Thread]">ignoreThreads</a>.<a title="(java.lang.Thread)Boolean" id="17941">contains</a>(<a href="#62960" title="java.lang.Thread">thread</a>)).<span title="((java.lang.Thread) =&gt; Unit)Unit">foreach</span>(<a href="#62901" title="(java.lang.Thread) =&gt; Unit">process</a>)
	}
	<span class="comment">/** Handles System.exit by disposing all frames and calling interrupt on all user threads */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread])Unit" id="62695">stopAll</a>(<a title="scala.collection.Set[java.lang.Thread]" id="62961">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread])
	{
		<a href="#62696" title="()Unit">disposeAllFrames</a>()
		<a href="#62697" title="(scala.collection.Set[java.lang.Thread])Unit">interruptAll</a>(<a href="#62961" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="62696">disposeAllFrames</a>()
	{
		<span class="keyword">val</span> <a title="Array[java.awt.Frame]" id="62962">allFrames</a> = java.awt.<a title="object java.awt.Frame" id="44027">Frame</a>.<a title="()Array[java.awt.Frame]" id="63022">getFrames</a>
		<span title="Unit" class="keyword">if</span>(<a href="#62962" title="Array[java.awt.Frame]">allFrames</a>.<a title="=&gt; Int" id="17100">length</a> <a title="(Int)Boolean" id="3093">&gt;</a> <span title="Int(0)" class="int">0</span>)
		{
			<a href="#62962" title="Array[java.awt.Frame]">allFrames</a>.<span title="((java.awt.Frame) =&gt; Unit)Unit">foreach</span>(<a href="#63110" title="java.awt.Frame">_</a>.<a title="()Unit" id="63155">dispose</a>) <span class="comment">// dispose all top-level windows, which will cause the AWT-EventQueue-* threads to exit</span>
			<span title="object java.lang.Thread">Thread</span>.<a title="(Long)Unit" id="33096">sleep</a>(<span title="Long(2000L)" class="int">2000</span>) <span class="comment">// AWT Thread doesn't exit immediately, so wait to interrupt it</span>
		}
	}
	<span class="comment">// interrupt all threads that appear to have been started by the user</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread])Unit" id="62697">interruptAll</a>(<a title="scala.collection.Set[java.lang.Thread]" id="62894">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread]): <span title="Unit">Unit</span> =
		<a href="#62694" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#62894" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#62698" title="(java.lang.Thread)Unit">safeInterrupt</a>)
	<span class="comment">// interrupts the given thread, but first replaces the exception handler so that the InterruptedException is not printed</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread)Unit" id="62698">safeInterrupt</a>(<a title="java.lang.Thread" id="64724">thread</a>: <span title="java.lang.Thread">Thread</span>)
	{
		<span title="Unit" class="keyword">if</span>(<span title="=&gt; Boolean">!</span><a href="#64724" title="java.lang.Thread">thread</a>.<span title="()java.lang.String">getName</span>.<span title="(java.lang.String)Boolean">startsWith</span>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>))
		{
			<a href="#64724" title="java.lang.Thread">thread</a>.<span title="(java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span>(<span title="sbt.TrapExit.TrapInterrupt" class="keyword">new</span> <a href="#62699" title="sbt.TrapExit.TrapInterrupt">TrapInterrupt</a>(<a href="#64724" title="java.lang.Thread">thread</a>.<a title="()java.lang.Thread.UncaughtExceptionHandler" id="33144">getUncaughtExceptionHandler</a>))
			<a href="#64724" title="java.lang.Thread">thread</a>.<a title="()Unit" id="33110">interrupt</a>
		}
	}
	<span class="comment">// an uncaught exception handler that swallows InterruptedExceptions and otherwise defers to originalHandler</span>
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapInterrupt extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject" id="62699">TrapInterrupt</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="64732">originalHandler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>) <span class="keyword">extends</span> Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>
	{
		<span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="64731">uncaughtException</a>(<a title="java.lang.Thread" id="64735">thread</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="64736">e</a>: <span title="Throwable">Throwable</span>)
		{
			<a href="#62687" title="(Throwable)((java.lang.InterruptedException) =&gt; Unit)((Throwable) =&gt; Unit)(implicit scala.reflect.Manifest[java.lang.InterruptedException])Unit">withCause</a>[<a title="java.lang.InterruptedException" id="1704">InterruptedException</a>, <span title="Unit">Unit</span>](<a href="#64736" title="Throwable">e</a>)
				{<a title="java.lang.InterruptedException" id="64740">interrupted</a> =&gt; <span title="Unit">(</span>)}
				{<a title="Throwable" id="64742">other</a> =&gt; <a href="#64732" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#64735" title="java.lang.Thread">thread</a>, <a href="#64736" title="Throwable">e</a>) }
			<a href="#64735" title="java.lang.Thread">thread</a>.<span title="(java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span>(<a href="#64732" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>)
		}
	}
	<span class="comment">/** An uncaught exception handler that delegates to the original uncaught exception handler except when
	* the cause was a call to System.exit (which generated a SecurityException)*/</span>
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitHandler extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject" id="62700">ExitHandler</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="62800">originalHandler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>, <a title="scala.collection.Set[java.lang.Thread]" id="62801">originalThreads</a>: <span title="scala.collection.Set[java.lang.Thread]">Set</span>[Thread], <a title="sbt.ExitCode" id="62802">codeHolder</a>: <a href="#10998" title="sbt.ExitCode">ExitCode</a>, <a title="sbt.Logger" id="62803">log</a>: <a href="Logger.scala.html#11784" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>
	{
		<span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="62799">uncaughtException</a>(<a title="java.lang.Thread" id="64750">t</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="64751">e</a>: <span title="Throwable">Throwable</span>)
		{
			<span class="keyword">try</span>
			{
				<a href="#62802" title="sbt.ExitCode">codeHolder</a>.<a href="#62717" title="(Int)Unit">set</a>(<a href="#62686" title="(Throwable)Int">exitCode</a>(<a href="#64751" title="Throwable">e</a>)) <span class="comment">// will rethrow e if it was not because of a call to System.exit</span>
				<a href="#62695" title="(scala.collection.Set[java.lang.Thread])Unit">stopAll</a>(<a href="#62801" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
			}
			<span class="keyword">catch</span>
			{
				<span title="Unit" class="keyword">case</span> _ =&gt;
					<a href="#62803" title="sbt.Logger">log</a>.<a href="Logger.scala.html#19514" title="(=&gt; Throwable)Unit">trace</a>(<a href="#64751" title="Throwable">e</a>)
					<a href="#62800" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#64750" title="java.lang.Thread">t</a>, <a href="#64751" title="Throwable">e</a>)
			}
		}
	}
	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitThreadGroup extends java.lang.ThreadGroup with ScalaObject" id="62701">ExitThreadGroup</a>(<a title="java.lang.Thread.UncaughtExceptionHandler" id="62789">handler</a>: Thread.<span title="java.lang.Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span>) <span class="keyword">extends</span> <span title="java.lang.ThreadGroup">ThreadGroup</span>(<span title="java.lang.String(&quot;trap.exit&quot;)" class="string">&quot;trap.exit&quot;</span>)
	{
		<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="62787">uncaughtException</a>(<a title="java.lang.Thread" id="64757">t</a>: <span title="java.lang.Thread">Thread</span>, <a title="Throwable" id="64758">e</a>: <span title="Throwable">Throwable</span>) = <a href="#62789" title="java.lang.Thread.UncaughtExceptionHandler">handler</a>.<span title="(java.lang.Thread,java.lang.Throwable)Unit">uncaughtException</span>(<a href="#64757" title="java.lang.Thread">t</a>, <a href="#64758" title="Throwable">e</a>)
	}
}
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitCode extends java.lang.Object with NotNull with ScalaObject" id="10998">ExitCode</a> <span class="keyword">extends</span> <a title="NotNull" id="189">NotNull</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[Int]" id="64761">code</a>: <span title="Option[Int]">Option</span>[Int] = <a title="object None" id="505">None</a>
	<span class="keyword">def</span> <a title="(Int)Unit" id="62717">set</a>(<a title="Int" id="62742">c</a>: <span title="Int">Int</span>): <span title="Unit">Unit</span> = <a href="#10998" title="(Unit)Unit">synchronized</a> { <a href="#64761" title="(Option[Int])Unit">code</a> = <a href="#64761" title="=&gt; Option[Int]">code</a> <a title="(=&gt; Option[Int])Option[Int]" id="19023">orElse</a> <a title="(Int)Some[Int]" id="286">Some</a>(<a href="#62742" title="Int">c</a>) }
	<span class="keyword">def</span> <a title="=&gt; Option[Int]" id="62718">value</a>: <span title="Option[Int]">Option</span>[Int] = <a href="#10998" title="(Option[Int])Option[Int]">synchronized</a> { <a href="#64761" title="=&gt; Option[Int]">code</a> }
}
<span class="comment">///////  These two classes are based on similar classes in Nailgun</span>
<span class="comment">/** A custom SecurityManager to disallow System.exit. */</span>
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapExitSecurityManager extends java.lang.SecurityManager with ScalaObject" id="9501">TrapExitSecurityManager</a>(<a title="java.lang.SecurityManager" id="62888">delegateManager</a>: <span title="java.lang.SecurityManager">SecurityManager</span>, <a title="java.lang.ThreadGroup" id="62889">group</a>: <span title="java.lang.ThreadGroup">ThreadGroup</span>) <span class="keyword">extends</span> <span title="java.lang.SecurityManager">SecurityManager</span>
{
	<span class="keyword">import</span> java.security.Permission
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(Int)Unit" id="62883">checkExit</a>(<a title="Int" id="64770">status</a>: <span title="Int">Int</span>)
	{
		<span class="keyword">val</span> <a title="Array[java.lang.StackTraceElement]" id="64771">stack</a> = <span title="object java.lang.Thread">Thread</span>.<a title="()java.lang.Thread" id="33094">currentThread</a>.<a title="()Array[java.lang.StackTraceElement]" id="33136">getStackTrace</a>
		<span title="Unit" class="keyword">if</span>(<a href="#64771" title="Array[java.lang.StackTraceElement]">stack</a> <span title="(AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <span title="(Boolean)Boolean">||</span> <a href="#64771" title="Array[java.lang.StackTraceElement]">stack</a>.<a title="((java.lang.StackTraceElement) =&gt; Boolean)Boolean" id="16072">exists</a>(<a href="#62884" title="(java.lang.StackTraceElement)Boolean">isRealExit</a>))
			<span title="Nothing" class="keyword">throw</span> <span title="sbt.TrapExitSecurityException" class="keyword">new</span> <a href="#8358" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a>(<a href="#64770" title="Int">status</a>)
	}
	<span class="comment">/** This ensures that only actual calls to exit are trapped and not just calls to check if exit is allowed.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.StackTraceElement)Boolean" id="62884">isRealExit</a>(<a title="java.lang.StackTraceElement" id="64773">element</a>: <a title="java.lang.StackTraceElement" id="1800">StackTraceElement</a>): <a title="Boolean" id="2115">Boolean</a> =
		<a href="#64773" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="30738">getClassName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;java.lang.Runtime&quot;)" class="string">&quot;java.lang.Runtime&quot;</span> <span title="(Boolean)Boolean">&amp;&amp;</span> <a href="#64773" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="30739">getMethodName</a> <span title="(AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;exit&quot;)" class="string">&quot;exit&quot;</span>
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission)Unit" id="62885">checkPermission</a>(<a title="java.security.Permission" id="64781">perm</a>: <span title="java.security.Permission">Permission</span>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#62888" title="java.lang.SecurityManager">delegateManager</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>)
			<a href="#62888" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission)Unit" id="62841">checkPermission</a>(<a href="#64781" title="java.security.Permission">perm</a>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission,AnyRef)Unit" id="62886">checkPermission</a>(<a title="java.security.Permission" id="64794">perm</a>: <span title="java.security.Permission">Permission</span>, <a title="AnyRef" id="64795">context</a>: <a title="AnyRef" id="1962">AnyRef</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#62888" title="java.lang.SecurityManager">delegateManager</a> <span title="(AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>)
			<a href="#62888" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission,Any)Unit" id="62842">checkPermission</a>(<a href="#64794" title="java.security.Permission">perm</a>, <a href="#64795" title="AnyRef">context</a>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.ThreadGroup" id="62887">getThreadGroup</a> = <a href="#62889" title="java.lang.ThreadGroup">group</a>
}
<span class="comment">/** A custom SecurityException that tries not to be caught.*/</span>
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapExitSecurityException extends java.lang.SecurityException with ScalaObject" id="8358">TrapExitSecurityException</a>(<span class="keyword">val</span> <a title="Int" id="64776">exitCode</a>: <span title="Int">Int</span>) <span class="keyword">extends</span> <a title="java.lang.SecurityException" id="1803">SecurityException</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="64806">accessAllowed</a> = <span title="Boolean(false)" class="keyword">false</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="62731">allowAccess</a>
	{
		<a href="#64806" title="(Boolean)Unit">accessAllowed</a> = <span title="Boolean(true)" class="keyword">true</span>
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="62732">printStackTrace</a> = <a href="#62738" title="(=&gt; Unit)Unit">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()Unit" id="17621">printStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="62733">toString</a> = <a href="#62738" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17620">toString</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="62734">getCause</a> = <a href="#62738" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<span title="()java.lang.Throwable">getCause</span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="62735">getMessage</a> = <a href="#62738" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17616">getMessage</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="62736">fillInStackTrace</a> = <a href="#62738" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.Throwable" id="17624">fillInStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="62737">getLocalizedMessage</a> = <a href="#62738" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="17617">getLocalizedMessage</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T](=&gt; T)T" id="62738">ifAccessAllowed</a>[<a title="&gt;: Nothing &lt;: Any" id="62740">T</a>](<a title="=&gt; T" id="64816">f</a>: =&gt; T): <a href="#62740" title="T">T</a> =
	{
		<span title="T" class="keyword">if</span>(<a href="#64806" title="=&gt; Boolean">accessAllowed</a>)
			<a href="#64816" title="=&gt; T">f</a>
		<span class="keyword">else</span>
			<span title="Nothing" class="keyword">throw</span> <a href="#8358" title="sbt.TrapExitSecurityException" class="keyword">this</a>
	}
}
        </pre>
    </body>
</html>