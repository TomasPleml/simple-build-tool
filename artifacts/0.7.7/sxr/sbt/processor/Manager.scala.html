<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/processor/Manager.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2010  Mark Harrah
 */</span>
<span class="keyword">package</span> sbt.processor

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> xsbt.Paths._
<span class="keyword">import</span> ProcessorException.error

<span class="comment">/** Files needed by ManagerImpl.
* `retrieveBaseDirectory` is the directory that processors are retrieved under.
* `retrieveLockFile` is used to synchronize access to that directory.
* `definitionsFile` is the file to save repository and processor definitions to.  It is usually per-user instead of per-project.*/</span>
<span class="keyword">class</span> <a title="class ManagerFiles extends java.lang.Object with ScalaObject" id="14864">ManagerFiles</a>(<span class="keyword">val</span> <a title="java.io.File" id="69700">retrieveBaseDirectory</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69701">retrieveLockFile</a>: <span title="java.io.File">File</span>, <span class="keyword">val</span> <a title="java.io.File" id="69702">definitionsFile</a>: <span title="java.io.File">File</span>)

<span class="keyword">class</span> <a title="class ManagerImpl extends java.lang.Object with sbt.processor.Manager with ScalaObject" id="14978">ManagerImpl</a>(<a title="sbt.processor.ManagerFiles" id="69678">files</a>: <a href="#14864" title="sbt.processor.ManagerFiles">ManagerFiles</a>, <a title="String" id="69679">scalaVersion</a>: <span title="String">String</span>, <a title="sbt.processor.Persist" id="69680">persist</a>: <a href="Persist.scala.html#14915" title="sbt.processor.Persist">Persist</a>, <a title="Boolean" id="69681">localOnly</a>: <span title="Boolean">Boolean</span>, <a title="sbt.Logger" id="69682">log</a>: <a href="../Logger.scala.html#13532" title="sbt.Logger">Logger</a>) <span class="keyword">extends</span> <a href="Processor.scala.html#14798" title="sbt.processor.Manager">Manager</a>
{
	<span class="keyword">import</span> files._
	
	<span class="keyword">def</span> <a title="(String)Option[sbt.processor.ProcessorDefinition]" id="69655">processorDefinition</a>(<a title="String" id="90684">label</a>: <span title="String">String</span>): <span title="Option[sbt.processor.ProcessorDefinition]">Option</span>[ProcessorDefinition] = <a href="#69665" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">processors</a>.<span title="(String)Option[sbt.processor.ProcessorDefinition]">get</span>(<a href="#90684" title="String">label</a>)
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Option[sbt.processor.Processor]" id="69656">processor</a>(<a title="sbt.processor.ProcessorDefinition" id="90687">pdef</a>: <a href="Processor.scala.html#14801" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>): <span title="Option[sbt.processor.Processor]">Option</span>[Processor] =
	{
		<span class="keyword">def</span> <a title="=&gt; Either[Throwable,sbt.processor.Processor]" id="91018">tryProcessor</a>: <a title="Either[Throwable,sbt.processor.Processor]" id="336">Either</a>[Throwable, Processor] =
			(<span title="sbt.processor.Loader" class="keyword">new</span> <a href="Loader.scala.html#14957" title="sbt.processor.Loader">Loader</a>).<a href="Loader.scala.html#90798" title="(java.io.File)Either[Throwable,sbt.processor.Processor]">getProcessor</a>( <a href="#69673" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#90687" title="sbt.processor.ProcessorDefinition">pdef</a>) )

		 <span class="comment">// try to load the processor.  It will succeed here if the processor has already been retrieved</span>
		<a href="#91018" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Either[Unit,sbt.processor.Processor])Either[Unit,sbt.processor.Processor]" id="53269">flatMap</a> { <a title="Throwable" id="91039">_</a> =&gt;
			 <span class="comment">// if it hasn't been retrieved, retrieve the processor and its dependencies</span>
			<a href="#69660" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#90687" title="sbt.processor.ProcessorDefinition">pdef</a>, <a href="#69681" title="Boolean">localOnly</a>)
			<span class="comment">// try to load the processor now that it has been retrieved</span>
			<a href="#91018" title="=&gt; Either[Throwable,sbt.processor.Processor]">tryProcessor</a>.<span title="=&gt; Either.LeftProjection[Throwable,sbt.processor.Processor]">left</span>.<a title="((Throwable) =&gt; Unit)Either[Unit,sbt.processor.Processor] with Product" id="53272">map</a> <a href="#91048" title="Unit">{</a> <span class="comment">// if that fails, log a warning</span>
				<span title="Unit" class="keyword">case</span> <a title="sbt.processor.ProcessorException" id="91049">p</a>: <a href="Processor.scala.html#14885" title="sbt.processor.ProcessorException">ProcessorException</a> =&gt; <a href="#69682" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#52376" title="(=&gt; String)Unit">warn</a>(<a href="#91049" title="sbt.processor.ProcessorException">p</a>.<a title="()java.lang.String" id="18025">getMessage</a>)
				<span title="Unit" class="keyword">case</span> <a title="Throwable" id="91051">t</a> =&gt; <a href="#69682" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#52372" title="(=&gt; Throwable)Unit">trace</a>(<a href="#91051" title="Throwable">t</a>); <a href="#69682" title="sbt.Logger">log</a>.<a href="../Logger.scala.html#52376" title="(=&gt; String)Unit">warn</a>(<a href="#91051" title="Throwable">t</a>.<a title="()java.lang.String" id="18029">toString</a>)
			}
		}.<a title="=&gt; Either.RightProjection[Unit,sbt.processor.Processor]" id="53342">right</a>.<a title="=&gt; Option[sbt.processor.Processor]" id="53314">toOption</a>
	}
	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)Unit" id="69657">defineProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="91056">p</a>: <a href="Processor.scala.html#14801" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>)
	{
		<a href="#69666" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#91056" title="sbt.processor.ProcessorDefinition">p</a>)
		<a href="#69660" title="(sbt.processor.ProcessorDefinition,Boolean)Unit">retrieveProcessor</a>(<a href="#91056" title="sbt.processor.ProcessorDefinition">p</a>, <a href="#69681" title="Boolean">localOnly</a>)
		<a href="#69661" title="(sbt.processor.Definition)Unit">add</a>(<a href="#91056" title="sbt.processor.ProcessorDefinition">p</a>)
	}
	<span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)Unit" id="69658">defineRepository</a>(<a title="sbt.processor.RepositoryDefinition" id="91059">r</a>: <a href="Processor.scala.html#14816" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>)
	{
		<a href="#69666" title="(sbt.processor.Definition)Unit">checkExisting</a>(<a href="#91059" title="sbt.processor.RepositoryDefinition">r</a>)
		<a href="#69661" title="(sbt.processor.Definition)Unit">add</a>(<a href="#91059" title="sbt.processor.RepositoryDefinition">r</a>)
	}
	<span class="keyword">def</span> <a title="(String)sbt.processor.Definition" id="69659">removeDefinition</a>(<a title="String" id="91060">label</a>: <span title="String">String</span>): <a href="Processor.scala.html#14858" title="sbt.processor.Definition">Definition</a> =
		<a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<a title="(String)Option[sbt.processor.Definition]" id="38004">removeKey</a>(<a href="#91060" title="String">label</a>) <span title="sbt.processor.Definition" class="keyword">match</span>
		{
			<span title="sbt.processor.Definition" class="keyword">case</span> Some(<a title="sbt.processor.Definition" id="91061">removed</a>) =&gt;
				<a href="#69674" title="()Unit">saveDefinitions</a>()
				<a href="#91061" title="sbt.processor.Definition">removed</a>
			<span title="Nothing" class="keyword">case</span> <a title="object None" id="505">None</a> =&gt; <a href="Processor.scala.html#69684" title="(String)Nothing">error</a>(<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#91060" title="String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' not defined.&quot;)" class="string">&quot;' not defined.&quot;</span>)
		}
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition,Boolean)Unit" id="69660">retrieveProcessor</a>(<a title="sbt.processor.ProcessorDefinition" id="91040">p</a>: <a href="Processor.scala.html#14801" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>, <a title="Boolean" id="91041">localOnly</a>: <span title="Boolean">Boolean</span>): <span title="Unit">Unit</span> =
	{
		<span class="keyword">val</span> <a title="List[sbt.Resolver]" id="91073">resolvers</a> = <a href="#69664" title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">repositories</a>.<span title="=&gt; Iterator[sbt.processor.RepositoryDefinition]">values</span>.<span title="=&gt; List[sbt.processor.RepositoryDefinition]">toList</span>.<a title="((sbt.processor.RepositoryDefinition) =&gt; sbt.Resolver)List[sbt.Resolver]" id="15727">map</a>(<a href="#69672" title="(sbt.processor.RepositoryDefinition)sbt.Resolver">toResolver</a>)
		<span class="keyword">val</span> <a title="sbt.ModuleID" id="91074">module</a> = <a href="#91040" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#90644" title="(String)sbt.ModuleID">toModuleID</a>(<a href="#69679" title="String">scalaVersion</a>)
		( <span title="sbt.processor.Retrieve" class="keyword">new</span> <a href="Retrieve.scala.html#14954" title="sbt.processor.Retrieve">Retrieve</a>(<a href="#69673" title="(sbt.processor.ProcessorDefinition)java.io.File">retrieveDirectory</a>(<a href="#91040" title="sbt.processor.ProcessorDefinition">p</a>), <a href="#91074" title="sbt.ModuleID">module</a>, <a href="#69680" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#69726" title="=&gt; xsbti.GlobalLock">lock</a>, <a href="#69701" title="=&gt; java.io.File">retrieveLockFile</a>, <a href="#91073" title="List[sbt.Resolver]">resolvers</a>, <a href="#69682" title="sbt.Logger">log</a>) ).<a href="Retrieve.scala.html#91138" title="(Boolean)Unit">retrieve</a>(<a href="#91041" title="Boolean">localOnly</a>)
	}
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69661">add</a>(<a title="sbt.processor.Definition" id="91058">d</a>: <a href="Processor.scala.html#14858" title="sbt.processor.Definition">Definition</a>)
	{
		<a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>(<a href="#91058" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#90613" title="=&gt; String">label</a>) = <a href="#91058" title="sbt.processor.Definition">d</a>
		<a href="#69674" title="()Unit">saveDefinitions</a>()
	}

	<span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69663">definitions</a> = <a href="#69676" title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]">loadDefinitions</a>(<a href="#69702" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]" id="69664">repositories</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.RepositoryDefinition)])scala.collection.immutable.Map[String,sbt.processor.RepositoryDefinition]">++</span> <a href="#69667" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.RepositoryDefinition)])Iterable[(String, sbt.processor.RepositoryDefinition)]">partialMap</a>(<a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#91103" title="(String, sbt.processor.RepositoryDefinition)">{</a> <span title="(String, sbt.processor.RepositoryDefinition)" class="keyword">case</span> (<a title="String" id="91104">label</a>, <a title="sbt.processor.RepositoryDefinition" id="91105">d</a>: <a href="Processor.scala.html#14816" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>) =&gt; <span title="(String,sbt.processor.RepositoryDefinition)(String, sbt.processor.RepositoryDefinition)">(</span><a href="#91104" title="String">label</a>, <a href="#91105" title="sbt.processor.RepositoryDefinition">d</a>) }
	<span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]" id="69665">processors</a> = <span title="((String, Nothing)*)scala.collection.immutable.Map[String,Nothing]">Map</span>() <span title="(Iterable[(String, sbt.processor.ProcessorDefinition)])scala.collection.immutable.Map[String,sbt.processor.ProcessorDefinition]">++</span> <a href="#69667" title="(Iterable[(String, sbt.processor.Definition)])(PartialFunction[(String, sbt.processor.Definition),(String, sbt.processor.ProcessorDefinition)])Iterable[(String, sbt.processor.ProcessorDefinition)]">partialMap</a>(<a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>) <a href="#91007" title="(String, sbt.processor.ProcessorDefinition)">{</a> <span title="(String, sbt.processor.ProcessorDefinition)" class="keyword">case</span> (<a title="String" id="91008">label</a>, <a title="sbt.processor.ProcessorDefinition" id="91009">p</a>: <a href="Processor.scala.html#14801" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) =&gt; <span title="(String,sbt.processor.ProcessorDefinition)(String, sbt.processor.ProcessorDefinition)">(</span><a href="#91008" title="String">label</a>, <a href="#91009" title="sbt.processor.ProcessorDefinition">p</a>) }
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.Definition)Unit" id="69666">checkExisting</a>(<a title="sbt.processor.Definition" id="91057">p</a>: <a href="Processor.scala.html#14858" title="sbt.processor.Definition">Definition</a>): <span title="Unit">Unit</span>  =  <a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="(String)Option[sbt.processor.Definition]">get</span>(<a href="#91057" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#90613" title="=&gt; String">label</a>) <a title="((sbt.processor.Definition) =&gt; Nothing)Option[Nothing]" id="30533">map</a> { <a title="sbt.processor.Definition" id="91155">d</a> =&gt; <a href="Processor.scala.html#69684" title="(String)Nothing">error</a> (<span title="java.lang.String(&quot;Label '&quot;)" class="string">&quot;Label '&quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#91057" title="sbt.processor.Definition">p</a>.<a href="Processor.scala.html#90613" title="=&gt; String">label</a> <span title="(Any)java.lang.String">+</span> <span title="java.lang.String(&quot;' already in use: &quot;)" class="string">&quot;' already in use: &quot;</span> <span title="(Any)java.lang.String">+</span> <a href="#91155" title="sbt.processor.Definition">d</a>) }
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T, S](Iterable[T])(PartialFunction[T,S])Iterable[S]" id="69667">partialMap</a>[<a title="&gt;: Nothing &lt;: Any" id="69670">T</a>,<a title="&gt;: Nothing &lt;: Any" id="69671">S</a>](<a title="Iterable[T]" id="90997">i</a>: <a title="Iterable[T]" id="372">Iterable</a>[T])(<a title="PartialFunction[T,S]" id="90998">f</a>: <a title="PartialFunction[T,S]" id="1245">PartialFunction</a>[T,S]) = <a href="#90997" title="Iterable[T]">i</a>.<a title="((T) =&gt; Boolean)Iterable[T]" id="16142">filter</a>(<a href="#90998" title="PartialFunction[T,S]">f</a>.<a href="#91001" title="(T)Boolean" id="16106">isDefinedAt</a>).<a title="((T) =&gt; S)Iterable[S]" id="16138">map</a>(<a href="#90998" title="PartialFunction[T,S]">f</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(sbt.processor.RepositoryDefinition)sbt.Resolver" id="69672">toResolver</a>(<a title="sbt.processor.RepositoryDefinition" id="91116">repo</a>: <a href="Processor.scala.html#14816" title="sbt.processor.RepositoryDefinition">RepositoryDefinition</a>): <a href="../../IvyInterface.scala.html#12833" title="sbt.Resolver">Resolver</a> = <span title="sbt.MavenRepository" class="keyword">new</span> <a href="../../IvyInterface.scala.html#10067" title="sbt.MavenRepository">MavenRepository</a>(<a href="#91116" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#90616" title="=&gt; String">label</a>, <a href="#91116" title="sbt.processor.RepositoryDefinition">repo</a>.<a href="Processor.scala.html#90618" title="=&gt; String">url</a>)

	<span class="keyword">def</span> <a title="(sbt.processor.ProcessorDefinition)java.io.File" id="69673">retrieveDirectory</a>(<a title="sbt.processor.ProcessorDefinition" id="91020">p</a>: <a href="Processor.scala.html#14801" title="sbt.processor.ProcessorDefinition">ProcessorDefinition</a>) = <a href="../../Paths.scala.html#20819" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">retrieveBaseDirectory</a> <a href="../../Paths.scala.html#20819" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#91020" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#90635" title="=&gt; String">group</a> <a href="../../Paths.scala.html#20819" title="implicit xsbt.Paths.fileToPath : (java.io.File)xsbt.Path">/</a> <a href="#91020" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#90637" title="=&gt; String">module</a> <a href="../../Paths.scala.html#20867" title="(String)java.io.File">/</a> <a href="#91020" title="sbt.processor.ProcessorDefinition">p</a>.<a href="Processor.scala.html#90639" title="=&gt; String">rev</a>
	
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="69674">saveDefinitions</a>(): <span title="Unit">Unit</span> = <a href="#69675" title="(java.io.File)Unit">saveDefinitions</a>(<a href="#69702" title="=&gt; java.io.File">definitionsFile</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Unit" id="69675">saveDefinitions</a>(<a title="java.io.File" id="91063">file</a>: <span title="java.io.File">File</span>): <span title="Unit">Unit</span> = <a href="#69680" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#69734" title="(java.io.File)(Iterable[sbt.processor.Definition])Unit">save</a>(<a href="#91063" title="java.io.File">file</a>)(<a href="#69662" title="=&gt; scala.collection.mutable.Map[String,sbt.processor.Definition]">definitions</a>.<span title="=&gt; Iterator[sbt.processor.Definition]">values</span>.<span title="=&gt; List[sbt.processor.Definition]">toList</span>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="69676">loadDefinitions</a>(<a title="java.io.File" id="91005">file</a>: <span title="java.io.File">File</span>): scala.collection.mutable.<a title="scala.collection.mutable.Map[String,sbt.processor.Definition]" id="20219">Map</a>[String, Definition] =
		scala.collection.mutable.<a title="((String, sbt.processor.Definition)*)scala.collection.mutable.Map[String,sbt.processor.Definition]" id="20418">HashMap</a>(  (<span title="Seq[(String, sbt.processor.Definition)]" class="keyword">if</span>(<a href="#91005" title="java.io.File">file</a>.<a title="()Boolean" id="16968">exists</a>) <a href="#69677" title="(java.io.File)Seq[(String, sbt.processor.Definition)]">rawLoad</a>(<a href="#91005" title="java.io.File">file</a>) <span class="keyword">else</span> <a title="object Nil" id="310">Nil</a>) : _*)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.io.File)Seq[(String, sbt.processor.Definition)]" id="69677">rawLoad</a>(<a title="java.io.File" id="91164">file</a>: <span title="java.io.File">File</span>): <a title="Seq[(String, sbt.processor.Definition)]" id="729">Seq</a>[(String, Definition)] = <a href="#69680" title="sbt.processor.Persist">persist</a>.<a href="Persist.scala.html#69735" title="(java.io.File)Seq[sbt.processor.Definition]">load</a>(<a href="#69702" title="=&gt; java.io.File">definitionsFile</a>).<a title="((sbt.processor.Definition) =&gt; (String, sbt.processor.Definition))Seq[(String, sbt.processor.Definition)]" id="16016">map</a> { <a title="sbt.processor.Definition" id="91170">d</a> =&gt; <span title="(String,sbt.processor.Definition)(String, sbt.processor.Definition)">(</span><a href="#91170" title="sbt.processor.Definition">d</a>.<a href="Processor.scala.html#90613" title="=&gt; String">label</a>, <a href="#91170" title="sbt.processor.Definition">d</a>) }
}
        </pre>
    </body>
</html>